<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análise de Andebol ao Vivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Bibliotecas para ler e escrever ficheiros XLSX (Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Bibliotecas para gerar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <!-- Biblioteca para Gráficos D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .btn-feedback:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .shot-type-btn.selected, .shot-zone-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #6366f1; /* indigo-500 */
        }
        .toggled-on, .passive-active, .opponent-7v6-active {
            color: white;
        }
        .toggled-on {
             background-color: #16a34a; /* green-600 */
        }
        .passive-active {
            background-color: #dc2626; /* red-600 */
        }
        .passive-active:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .opponent-7v6-active {
            background-color: #ea580c; /* orange-600 */
        }
        .opponent-7v6-active:hover {
            background-color: #c2410c; /* orange-700 */
        }
        .tab-btn.active {
            color: #60a5fa; /* blue-400 */
            border-color: #3b82f6; /* blue-600 */
        }
        .timeline-tooltip {
            visibility: hidden;
            width: 180px;
            background-color: #1f2937;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 8px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        .timeline-event:hover .timeline-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .court-stats-text {
            font-size: 12px;
            font-weight: bold;
            fill: white;
            text-anchor: middle;
        }
        /* Estilos para os gráficos D3 */
        .chart-container .bar {
            fill: #3b82f6; /* blue-600 */
        }
        .chart-container .bar-label {
            fill: white;
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
        }
        .chart-container .axis-label {
            fill: #9ca3af; /* gray-400 */
            font-size: 11px;
        }
        .chart-container .domain, .chart-container .tick line {
            stroke: #4b5563; /* gray-600 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <!-- Ecrã de Carregamento Inicial -->
    <div id="welcomeModal" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-8 w-full max-w-md text-center shadow-2xl">
            <h2 class="text-3xl font-bold text-blue-400 mb-4">Preparar Jogo</h2>
            <p class="text-gray-400 mb-8">Carregue o ficheiro do jogo (.xlsx) e indique o nome do adversário.</p>
            
            <div class="space-y-6 mb-8">
                <!-- Carregar Ficheiro do Jogo -->
                <div>
                    <input type="file" id="welcome-file-input-A" class="hidden" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    <label for="welcome-file-input-A" class="cursor-pointer w-full block bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg">
                        Carregar Ficheiro do Jogo (.xlsx)
                    </label>
                    <p id="file-name-A" class="text-sm text-gray-500 mt-2 h-5">Nenhum ficheiro selecionado</p>
                </div>
                
                <!-- Nome da Equipa B -->
                <div>
                    <input type="text" id="welcome-team-b-name" placeholder="Nome da Equipa Adversária" class="w-full bg-gray-700 text-white text-center text-lg font-semibold p-3 rounded-lg border-2 border-gray-600 focus:border-orange-500 focus:outline-none">
                </div>
            </div>

            <button id="startGameBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                Começar Jogo
            </button>
        </div>
    </div>

    <div id="main-app" class="container mx-auto p-4 md:p-6 lg:p-8 hidden">

        <!-- Nomes das Equipas -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
            <input type="text" id="teamAName" value="Academia de Andebol SPS" readonly class="w-full bg-gray-800 text-white text-center text-xl font-semibold p-3 rounded-lg border-2 border-gray-700 focus:outline-none">
            <input type="text" id="teamBName" placeholder="Nome da Equipa B" class="w-full bg-gray-800 text-white text-center text-xl font-semibold p-3 rounded-lg border-2 border-gray-700 focus:border-orange-500 focus:outline-none">
        </div>

        <!-- Painel de Estatísticas ao Vivo -->
        <div class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-300">Estatísticas ao Vivo</h2>
            <div class="flex justify-around items-center text-center">
                <div class="flex-1"><p id="statsTeamAName" class="text-lg font-semibold text-blue-400">Equipa A</p><p id="scoreA" class="text-5xl font-bold">0</p></div>
                <div class="text-4xl font-light text-gray-500 mx-4">-</div>
                <div class="flex-1"><p id="statsTeamBName" class="text-lg font-semibold text-orange-400">Equipa B</p><p id="scoreB" class="text-5xl font-bold">0</p></div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-4 text-center text-sm md:text-base">
                <div><p class="font-semibold text-gray-400">Efic. Ataque</p><p><span id="effA" class="text-blue-400 font-medium">0%</span> vs <span id="effB" class="text-orange-400 font-medium">0%</span></p></div>
                <div><p class="font-semibold text-gray-400">Pontuação</p><p><span id="performanceScoreA" class="text-blue-400 font-medium">0</span></p></div>
                <div><p class="font-semibold text-gray-400">Total Remates</p><p><span id="shotsA" class="text-blue-400 font-medium">0</span> vs <span id="shotsB" class="text-orange-400 font-medium">0</span></p></div>
                <div><p class="font-semibold text-gray-400">Defesas GR</p><p><span id="savesA" class="text-blue-400 font-medium">0</span> vs <span id="savesB" class="text-orange-400 font-medium">0</span></p></div>
            </div>
        </div>

        <!-- Blocos de Tempo e Situação -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
            <!-- Cronómetro -->
            <div class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg text-center">
                <div class="flex justify-center items-center gap-4 mb-4">
                    <h2 class="text-2xl font-bold text-gray-300">Tempo de Jogo</h2>
                    <div class="flex items-center gap-2">
                        <span id="gamePartDisplay" class="font-semibold bg-gray-700 px-3 py-1 rounded-md text-sm">1ª Parte</span>
                        <button id="switchPartBtn" class="btn-feedback bg-blue-600 hover:bg-blue-700 rounded-full w-8 h-8 flex items-center justify-center transition-transform active:scale-90" title="Mudar Parte">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        </button>
                    </div>
                </div>
                <div id="timer" class="text-6xl font-mono tracking-widest mb-4">00:00</div>
                <div id="timeout-timer-display" class="hidden mb-4">
                    <p id="timeout-title" class="text-lg font-semibold">Time-out</p>
                    <p id="timeout-timer" class="text-4xl font-mono"></p>
                </div>
                <div class="flex justify-center gap-4 mb-4">
                    <button id="startBtn" class="btn-feedback bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Iniciar</button>
                    <button id="pauseBtn" class="btn-feedback bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200">Pausar</button>
                    <button id="openCorrectionModalBtn" class="btn-feedback bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 hidden">Corrigir Tempo</button>
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4 flex justify-around gap-4">
                    <button id="timeoutBtnA" data-team="A" class="btn-feedback bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg w-full">Time-out (<span id="timeout-count-A">3</span>)</button>
                    <button id="timeoutBtnB" data-team="B" class="btn-feedback bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg w-full">Time-out (<span id="timeout-count-B">3</span>)</button>
                </div>
            </div>

            <!-- Situação de Jogo -->
            <div class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg text-center flex flex-col justify-between">
                <div>
                    <h2 class="text-2xl font-bold text-gray-300 mb-4">Situação de Jogo</h2>
                    <div class="space-y-3">
                        <button id="passivePlayBtn" class="btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg w-full">Jogo Passivo</button>
                        <button id="opponent7v6Btn" class="btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg w-full">Adversário 7x6</button>
                    </div>
                </div>
                <div class="border-t border-gray-700 pt-4 mt-4">
                    <h3 class="text-lg font-semibold text-gray-400 mb-3">Ações do Adversário</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="opponentTechFaultBtn" class="btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-3 rounded-lg text-sm">Falha Técnica</button>
                        <button id="opponentOfficialSanctionBtn" class="btn-feedback bg-red-800 hover:bg-red-700 text-white font-bold py-2 px-3 rounded-lg text-sm">Sanção Oficial</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Abas de Navegação -->
        <div class="mb-4 border-b border-gray-700">
            <nav class="flex -mb-px" id="tabs-container">
                <button data-tab="data-collection" class="tab-btn active whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm">Recolha de Dados</button>
                <button data-tab="team-stats" class="tab-btn whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-white hover:border-gray-300">Estatísticas de Equipa</button>
                <button data-tab="individual-stats" class="tab-btn whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-white hover:border-gray-300">Estatísticas Individuais</button>
                <button data-tab="plus-minus" class="tab-btn whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-white hover:border-gray-300">Plus - Minus</button>
                <button data-tab="timeline" class="tab-btn whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-white hover:border-gray-300">Time Line</button>
                <button data-tab="export" class="tab-btn whitespace-nowrap py-4 px-6 border-b-2 border-transparent font-medium text-sm text-gray-400 hover:text-white hover:border-gray-300">Exportar</button>
            </nav>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="tab-content">
            <!-- Aba de Recolha de Dados -->
            <div id="data-collection" class="tab-panel">
                <div class="bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg mb-8">
                    <div class="flex justify-between items-center mb-4">
                        <div class="flex items-center gap-2">
                            <h3 class="text-xl font-semibold text-blue-400">Plantel</h3>
                            <span id="game-situation-display" class="text-sm font-semibold text-gray-400">(Igualdade)</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span id="team-suspension-display" class="text-sm font-mono text-red-500"></span>
                            <span id="opponent-team-suspension-display" class="text-sm font-mono text-green-500"></span>
                            <span id="player-count-A" class="text-sm font-semibold bg-gray-700 px-3 py-1 rounded-md text-red-400">0/7</span>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <h4 class="font-semibold text-gray-400 mb-2 border-b border-gray-700 pb-1">Guarda-Redes</h4>
                            <div id="goalkeeper-list-A" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-400 mb-2 border-b border-gray-700 pb-1">Jogadores de Campo</h4>
                            <div id="player-list-A" class="space-y-2"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-400 mb-2 border-b border-gray-700 pb-1 mt-4">Oficiais</h4>
                            <div id="officials-list-A" class="space-y-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Aba de Estatísticas de Equipa -->
            <div id="team-stats" class="tab-panel hidden bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg">
                <div id="team-stats-content" class="space-y-4">
                    <!-- JS will populate this content -->
                </div>
                <div class="mt-8 pt-4 border-t border-gray-700">
                     <div class="mb-4">
                         <label for="team-situation-select" class="block text-sm font-medium text-gray-300 mb-2">Filtrar por Situação de Jogo:</label>
                         <select id="team-situation-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                             <option value="all">Todos</option>
                             <option value="equality">Igualdade</option>
                             <option value="superiority">Superioridade</option>
                             <option value="inferiority">Inferioridade</option>
                             <option value="seven_vs_six">7x6</option>
                             <option value="passive">Passivo</option>
                         </select>
                       </div>
                     <div class="w-full max-w-2xl mx-auto aspect-video">
                         <svg id="team-handball-court-svg" viewBox="0 0 400 250" class="w-full h-full">
                             <rect width="400" height="250" fill="#1f2937"></rect>
                             <!-- Goal -->
                             <rect x="185" y="240" width="30" height="10" fill="none" stroke="white" stroke-width="1"></rect>
                             <!-- 6m line -->
                             <path d="M 140 240 A 60 60 0 0 1 260 240" fill="none" stroke="white" stroke-width="1"></path>
                             <line x1="140" y1="240" x2="140" y2="180" stroke="white" stroke-width="1"></line>
                             <line x1="260" y1="240" x2="260" y2="180" stroke="white" stroke-width="1"></line>
                             <!-- 9m line -->
                             <path d="M 110 240 A 90 90 0 0 1 290 240" fill="none" stroke="white" stroke-width="1" stroke-dasharray="4"></path>
                             <line x1="110" y1="240" x2="110" y2="150" stroke="white" stroke-width="1" stroke-dasharray="4"></line>
                             <line x1="290" y1="240" x2="290" y2="150" stroke="white" stroke-width="1" stroke-dasharray="4"></line>
                             <!-- 7m line -->
                             <line x1="195" y1="170" x2="205" y2="170" stroke="white" stroke-width="1"></line>
                             <!-- Center line -->
                             <line x1="200" y1="250" x2="200" y2="0" stroke="white" stroke-width="0.5" stroke-dasharray="2"></line>
                             
                             <!-- Stats text placeholders -->
                             <text id="team-zone-1-stats" x="65" y="210" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-2-stats" x="145" y="210" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-3-stats" x="200" y="210" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-4-stats" x="255" y="210" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-5-stats" x="335" y="210" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-6-stats" x="130" y="120" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-7-stats" x="200" y="120" class="court-stats-text">0% (0)</text>
                             <text id="team-zone-8-stats" x="270" y="120" class="court-stats-text">0% (0)</text>
                         </svg>
                       </div>
                </div>
            </div>

            <!-- Aba de Estatísticas Individuais -->
            <div id="individual-stats" class="tab-panel hidden bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold text-blue-400 mb-4">Dashboard do Jogador</h3>
                <div class="mb-6">
                    <label for="player-stats-select" class="block text-sm font-medium text-gray-300 mb-2">Selecionar Jogador:</label>
                    <select id="player-stats-select" class="bg-gray-700 border border-gray-600 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <!-- KPIs -->
                <div id="individual-kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                    <!-- KPI Cards will be populated by JS -->
                </div>

                <!-- Gráficos -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold text-center text-gray-300 mb-4">Distribuição de Remates</h4>
                        <div id="shot-distribution-chart" class="chart-container"></div>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-semibold text-center text-gray-300 mb-4">Eficácia por Tipo de Remate</h4>
                        <div id="shot-efficiency-chart" class="chart-container"></div>
                    </div>
                </div>

                <!-- Tabela de Estatísticas Detalhadas -->
                <div>
                    <h4 class="font-semibold text-center text-gray-300 mb-4">Estatísticas Detalhadas</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-400">
                            <thead class="text-xs text-gray-300 uppercase bg-gray-700">
                                <tr>
                                    <th scope="col" class="py-3 px-6">Métrica</th>
                                    <th scope="col" class="py-3 px-6 text-center">Valor</th>
                                </tr>
                            </thead>
                            <tbody id="individual-stats-table">
                                <!-- Table rows will be populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Aba Plus - Minus -->
            <div id="plus-minus" class="tab-panel hidden bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold text-blue-400 mb-6 text-center">Análise Plus - Minus</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Coluna da Esquerda -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-3 text-center border-b border-gray-700 pb-2">Melhor Saldo de Golos</h4>
                            <div id="plus-minus-best-diff"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-3 text-center border-b border-gray-700 pb-2">Mais Golos Marcados (em Campo)</h4>
                            <div id="plus-minus-most-goals-for"></div>
                        </div>
                    </div>
                    <!-- Coluna da Direita -->
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-3 text-center border-b border-gray-700 pb-2">Pior Saldo de Golos</h4>
                            <div id="plus-minus-worst-diff"></div>
                        </div>
                        <div>
                            <h4 class="font-semibold text-gray-300 mb-3 text-center border-b border-gray-700 pb-2">Mais Golos Sofridos (em Campo)</h4>
                            <div id="plus-minus-most-goals-against"></div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- Aba de Time Line -->
            <div id="timeline" class="tab-panel hidden bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold text-blue-400 mb-8 text-center">Time Line do Jogo</h3>
                <div class="relative w-full h-32 px-4">
                    <!-- Container para as barras de situação -->
                    <div id="timeline-situation-bars" class="absolute top-0 left-0 w-full h-full">
                        <!-- JS irá preencher isto -->
                    </div>
    
                    <!-- Eventos para a Equipa A (acima) -->
                    <div id="timeline-events-A" class="absolute bottom-1/2 w-full h-1/2 mb-1 flex items-end z-10">
                        <!-- JS irá preencher isto -->
                    </div>
    
                    <!-- Linha Central com Marcadores -->
                    <div class="absolute top-1/2 left-0 w-full h-0.5 bg-gray-500"></div>
                    <div id="timeline-markers" class="absolute top-1/2 left-0 w-full z-10">
                        <!-- JS irá preencher os marcadores de tempo -->
                    </div>
    
                    <!-- Eventos para a Equipa B (abaixo) -->
                    <div id="timeline-events-B" class="absolute top-1/2 w-full h-1/2 mt-1 flex items-start z-10">
                        <!-- JS irá preencher isto -->
                    </div>
                </div>
            </div>
            
            <!-- Aba de Exportação -->
            <div id="export" class="tab-panel hidden bg-gray-800 p-4 md:p-6 rounded-2xl shadow-lg">
                <h3 class="text-xl font-semibold text-blue-400 mb-6 text-center">Exportar Dados do Jogo</h3>
                <div class="flex flex-col md:flex-row justify-center items-center gap-6">
                    <button id="exportExcelBtn" class="btn-feedback bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg w-full md:w-auto">Exportar para Excel (.xlsx)</button>
                    <button id="exportPdfBtn" class="btn-feedback bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg w-full md:w-auto">Exportar para PDF (.pdf)</button>
                    <button id="resetGameBtn" class="btn-feedback bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-8 rounded-lg w-full md:w-auto">Reiniciar Jogo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="alertModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center shadow-2xl"><p id="alertText" class="text-lg mb-6"></p><button id="alertOk" class="btn-feedback bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-12 rounded-lg">OK</button></div></div>
    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4"><div class="bg-gray-800 rounded-lg p-6 w-full max-w-sm text-center shadow-2xl"><p id="modalText" class="text-lg mb-6"></p><div class="flex justify-center gap-4"><button id="confirmYes" class="btn-feedback bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-8 rounded-lg">Sim</button><button id="confirmNo" class="btn-feedback bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg">Não</button></div></div></div>
    
    <!-- Modal de Remate (Genérico) -->
    <div id="shotModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-2xl text-center shadow-2xl">
            <h3 id="shotModalTitle" class="text-xl font-bold text-blue-400 mb-2"></h3>
            <p id="shotPlayerName" class="text-lg font-semibold mb-4"></p>
            
            <div id="shot-types-container-wrapper" class="mb-4">
                <h4 class="font-semibold text-gray-400 mb-3">1. Tipo de Remate</h4>
                <div id="shot-types-container" class="grid grid-cols-3 sm:grid-cols-5 gap-2">
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">Ponta</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">Pivot</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">Penetração</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">6mt</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">9mt</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">7mt</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">1ª Vaga</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">2ª Vaga</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">3ª Vaga</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">Após Golo</button>
                    <button class="shot-type-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition col-span-3 sm:col-span-5">Baliza Aberta</button>
                </div>
            </div>

            <div id="shot-zone-container" class="mb-4 hidden">
                <h4 class="font-semibold text-gray-400 mb-3">2. Zona de Remate</h4>
                <div class="grid grid-cols-4 sm:grid-cols-8 gap-2 max-w-md mx-auto">
                    <button data-zone="1" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">1</button>
                    <button data-zone="2" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">2</button>
                    <button data-zone="3" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">3</button>
                    <button data-zone="4" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">4</button>
                    <button data-zone="5" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">5</button>
                    <button data-zone="6" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">6</button>
                    <button data-zone="7" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">7</button>
                    <button data-zone="8" class="shot-zone-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-3 rounded-lg transition">8</button>
                </div>
            </div>

            <div>
                <h4 id="shot-outcome-title" class="font-semibold text-gray-400 mb-3">2. Resultado do Remate</h4>
                <div id="shot-outcome-container" class="grid grid-cols-2 gap-4">
                    <button data-outcome="goal" class="shot-outcome-btn btn-feedback bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Golo</button>
                    <button data-outcome="saved" class="shot-outcome-btn btn-feedback bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Defesa</button>
                    <button data-outcome="miss" class="shot-outcome-btn btn-feedback bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Fora</button>
                    <button data-outcome="post" class="shot-outcome-btn btn-feedback bg-yellow-700 hover:bg-yellow-800 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed" disabled>Poste</button>
                </div>
            </div>
            <button id="closeShotModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>
    
    <!-- Modal de Ação Negativa -->
    <div id="negativeActionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-lg text-center shadow-2xl">
            <h3 class="text-xl font-bold text-yellow-400 mb-2">Registar Ação Negativa</h3>
            <p id="negativeActionPlayerName" class="text-lg font-semibold mb-6"></p>
            <div class="grid grid-cols-2 gap-4">
                <button data-negative-action="technical_fault" class="negative-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Falha Técnica</button>
                <button data-negative-action="turnover" class="negative-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Perda de Bola</button>
                <button data-negative-action="7m_foul" class="negative-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">7m Provocado</button>
                <button data-negative-action="sanction" class="negative-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Sanções</button>
                <button data-negative-action="2min_7m_foul" class="negative-action-btn btn-feedback bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg col-span-2">2min + 7m</button>
            </div>
            <button id="closeNegativeActionModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>

    <!-- Modal de Ação Positiva -->
    <div id="positiveActionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-lg text-center shadow-2xl">
            <h3 class="text-xl font-bold text-green-400 mb-2">Registar Ação Positiva</h3>
            <p id="positiveActionPlayerName" class="text-lg font-semibold mb-6"></p>
            <div class="grid grid-cols-2 gap-4">
                <button data-positive-action="assist" class="positive-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Assistência</button>
                <button data-positive-action="steal" class="positive-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">Roubo de Bola</button>
                <button data-positive-action="2min_provoked" class="positive-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">2min Provocado</button>
                <button data-positive-action="7m_provoked" class="positive-action-btn btn-feedback bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg">7m Provocado</button>
                <button data-positive-action="2min_7m_provoked" class="positive-action-btn btn-feedback bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-4 rounded-lg col-span-2">2min + 7m Provocado</button>
            </div>
            <button id="closePositiveActionModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>
    
    <!-- Modal de Sanções -->
    <div id="sanctionsModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold text-red-500 mb-2">Registar Sanção</h3>
            <p id="sanctionPlayerName" class="text-lg font-semibold mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="sanctionYellow" class="sanction-btn btn-feedback w-1/3 bg-yellow-500 hover:bg-yellow-600 text-black font-bold py-3 px-4 rounded-lg">Amarelo</button>
                <button id="sanction2Min" class="sanction-btn btn-feedback w-1/3 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg">2 Min</button>
                <button id="sanctionRed" class="sanction-btn btn-feedback w-1/3 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Vermelho</button>
            </div>
            <button id="closeSanctionsModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>
    
    <!-- Modal de Correção de Tempo -->
    <div id="correctionModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-sm text-center shadow-2xl">
            <h3 class="text-xl font-bold text-indigo-400 mb-4">Corrigir Tempo</h3>
            <div class="flex justify-center items-center gap-2">
                <input type="number" id="correctMinutes" min="0" max="99" placeholder="MM" class="w-24 bg-gray-700 text-white text-center p-2 rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
                <span class="font-bold text-gray-500 text-2xl">:</span>
                <input type="number" id="correctSeconds" min="0" max="59" placeholder="SS" class="w-24 bg-gray-700 text-white text-center p-2 rounded-lg border border-gray-600 focus:outline-none focus:border-indigo-500">
            </div>
            <div class="flex justify-center gap-4 mt-6">
                 <button id="setTimerBtn" class="btn-feedback bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-8 rounded-lg">Aplicar</button>
                 <button id="closeCorrectionModalBtn" class="btn-feedback bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-8 rounded-lg">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Remover Jogador (Sanção do Banco) -->
    <div id="removePlayerModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 p-4">
        <div class="bg-gray-800 rounded-2xl p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold text-red-500 mb-4">Sanção de Banco</h3>
            <p class="text-gray-300 mb-6">Selecione um jogador em campo para retirar durante 2 minutos.</p>
            <div id="remove-player-list" class="space-y-2 max-h-64 overflow-y-auto"></div>
            <button id="closeRemovePlayerModalBtn" class="mt-6 text-gray-400 hover:text-white">Cancelar</button>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Scoring System Definition ---
            const pointSystem = {
                goalkeeper: {
                    shot: { // GK shoots on open goal
                        goal: 10,
                        fail: -1 // miss, saved, post
                    },
                    shot_faced: { // GK faces a shot
                        'Ponta': { saved: 7, goal: -3 },
                        'Pivot': { saved: 9, goal: -1 },
                        'Penetração': { saved: 8, goal: -2 },
                        '6mt': { saved: 8, goal: -2 },
                        '9mt': { saved: 7, goal: -3 },
                        '7mt': { saved: 8, goal: -2 },
                        '1ª Vaga': { saved: 8, goal: -2 },
                        '2ª Vaga': { saved: 8, goal: -2 },
                        '3ª Vaga': { saved: 8, goal: -2 },
                        'Após Golo': { saved: 8, goal: -2 },
                        'Baliza Aberta': { saved: 10, goal: -1 }
                    },
                    positive_actions: {
                        '2min_provoked': 1,
                        '2min_7m_provoked': 1
                    },
                    negative_actions: {
                        'technical_fault': -6,
                        'turnover': -8,
                        '7m_foul': -1,
                        'sanction_yellow': 0,
                        'sanction_2min': -1,
                        'sanction_red': -12,
                        '2min_7m_foul': -2 // Combines 2min (-1) and 7m foul (-1)
                    }
                },
                field_player: {
                    shot: {
                        'Ponta': { goal: 6, fail: -7 },
                        'Pivot': { goal: 6, fail: -7 },
                        'Penetração': { goal: 6, fail: -7 },
                        '6mt': { goal: 6, fail: -7 },
                        '9mt': { goal: 10, fail: -4 },
                        '7mt': { goal: 6, fail: -8 },
                        '1ª Vaga': { goal: 5, fail: -8 },
                        '2ª Vaga': { goal: 5, fail: -8 },
                        '3ª Vaga': { goal: 5, fail: -8 },
                        'Após Golo': { goal: 5, fail: -8 },
                        'Baliza Aberta': { goal: 10, fail: -1 }
                    },
                    positive_actions: {
                        'assist': 4, // Added assist
                        'steal': 8,
                        '2min_provoked': 1,
                        '7m_provoked': 3,
                        '2min_7m_provoked': 4 // Combines 2min (1) and 7m (3)
                    },
                    negative_actions: {
                        'technical_fault': -6,
                        'turnover': -8,
                        '7m_foul': -1,
                        'sanction_yellow': 0,
                        'sanction_2min': -1,
                        'sanction_red': -12,
                        '2min_7m_foul': -2 // Combines 2min (-1) and 7m foul (-1)
                    }
                }
            };

            // --- Final Score Ranges ---
            const finalScoreRanges = {
                'LE': { min: 58, max: 179 },
                'C':  { min: 58, max: 179 },
                'LD': { min: 58, max: 179 },
                'PE': { min: 69, max: 169 },
                'PD': { min: 69, max: 169 },
                'PV': { min: 62, max: 161 },
                'GR': { min: 58, max: 203 }
            };

            let gameData = {
                A: { stats: { goals: 0, misses: 0, savedShots: 0, turnovers: 0, gkSaves: 0, gkGoalsAgainst: 0 }, players: [], officials: [], fileLoaded: false, teamYellowCards: 0, isTeamSuspended: false, teamSuspensionTimer: 0, timeouts: { total: 3, part1: 0, part2: 0, taken: [] }, officialsSanctions: { yellow: 0, twoMin: 0, red: 0 } },
                B: { stats: { goals: 0, misses: 0, savedShots: 0, turnovers: 0, technical_faults: 0, transition_goals: 0, gkSaves: 0, gkGoalsAgainst: 0 }, isSuspended: false, suspensionTimer: 0, timeouts: { total: 3, part1: 0, part2: 0, taken: [] } }
            };

            let timerInterval = null;
            let timeoutInterval = null;
            let totalSeconds = 0;
            const FIRST_HALF_END = 1800, SECOND_HALF_END = 3600;
            let isTimerRunning = false, currentGamePart = 1;
            let currentPersonForAction = null;
            let selectedShotType = null;
            let selectedShotZone = null;
            let isGkShot = false;
            let actionAfterPlayerRemoval = null;
            let isPassivePlay = false;
            let gameEvents = [];
            let gameSituationLog = [];
            let lastKnownSituations = { A: 'equality', B: 'equality' };
            let isOpponent7v6 = false;

            // DOM Elements
            const welcomeModal = document.getElementById('welcomeModal');
            const mainApp = document.getElementById('main-app');
            const startGameBtn = document.getElementById('startGameBtn');
            const timerDisplay = document.getElementById('timer');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const gamePartDisplay = document.getElementById('gamePartDisplay');
            const playerCountADisplay = document.getElementById('player-count-A');
            const teamSuspensionDisplay = document.getElementById('team-suspension-display');
            const opponentTeamSuspensionDisplay = document.getElementById('opponent-team-suspension-display');
            const openCorrectionModalBtn = document.getElementById('openCorrectionModalBtn');
            const timeoutBtnA = document.getElementById('timeoutBtnA');
            const timeoutBtnB = document.getElementById('timeoutBtnB');
            const timeoutTimerDisplay = document.getElementById('timeout-timer-display');
            const timeoutTimer = document.getElementById('timeout-timer');
            const timeoutTitle = document.getElementById('timeout-title');
            const gameSituationDisplay = document.getElementById('game-situation-display');
            const opponentOfficialSanctionBtn = document.getElementById('opponentOfficialSanctionBtn');
            const passivePlayBtn = document.getElementById('passivePlayBtn');
            const opponent7v6Btn = document.getElementById('opponent7v6Btn');
            const opponentTechFaultBtn = document.getElementById('opponentTechFaultBtn');
            const exportExcelBtn = document.getElementById('exportExcelBtn');
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            
            // Modals
            const alertModal = document.getElementById('alertModal'), alertText = document.getElementById('alertText'), alertOkBtn = document.getElementById('alertOk');
            const confirmModal = document.getElementById('confirmModal'), modalText = document.getElementById('modalText'), confirmYesBtn = document.getElementById('confirmYes'), confirmNoBtn = document.getElementById('confirmNo');
            const shotModal = document.getElementById('shotModal');
            const negativeActionModal = document.getElementById('negativeActionModal');
            const positiveActionModal = document.getElementById('positiveActionModal');
            const sanctionsModal = document.getElementById('sanctionsModal');
            const correctionModal = document.getElementById('correctionModal');
            const removePlayerModal = document.getElementById('removePlayerModal');
            let confirmCallback = null;

            // --- ALL FUNCTION DEFINITIONS ---

            // --- Scoring Calculation ---
            const calculateFinalScore = (player) => {
                const position = player.Posicao.trim().toUpperCase();
                const ranges = finalScoreRanges[position];
                if (!ranges) {
                    return 0; // Return 0 if position is not defined in the ranges
                }
                const { min, max } = ranges;
                const totalScore = player.performanceScore;
                if (max - min === 0) return 0; // Avoid division by zero

                // CORRECTED FORMULA
                const finalScore = ((totalScore + 100 - min) * 50) / ((max - min) + 50);
                return Math.round(finalScore);
            };

            const updatePlayerScore = (player, points) => {
                if (!player) return;
                player.performanceScore += points;
                player.finalScore = calculateFinalScore(player);
            };

            // --- Timeline and Situation Logic ---
            const logEvent = (team, type, player, time, details) => {
                gameEvents.push({ team, type, player, time, details });
                renderTimeline();
            };

            const getSituationA = () => {
                const onCourtA = gameData.A.players.filter(p => p.onCourt).length;
                const isGkOnCourtA = gameData.A.players.some(p => p.onCourt && p.isGoalkeeper);
                const onCourtB = isOpponent7v6 ? 7 : (gameData.B.isSuspended ? 6 : 7);

                if (onCourtA === 7 && !isGkOnCourtA) return 'seven_vs_six';
                if (onCourtA > onCourtB) return 'superiority';
                if (onCourtA < onCourtB) return 'inferiority';
                return 'equality';
            }

            const getSituationB = () => {
                const onCourtA = gameData.A.players.filter(p => p.onCourt).length;
                const onCourtB = isOpponent7v6 ? 7 : (gameData.B.isSuspended ? 6 : 7);

                if (isOpponent7v6) return 'seven_vs_six';
                if (onCourtB > onCourtA) return 'superiority';
                if (onCourtB < onCourtA) return 'inferiority';
                return 'equality';
            }

            const checkAndLogSituationChange = () => {
                const currentSituationA = getSituationA();
                const currentSituationB = getSituationB();

                if (currentSituationA !== lastKnownSituations.A || currentSituationB !== lastKnownSituations.B) {
                    const lastLog = gameSituationLog.length > 0 ? gameSituationLog[gameSituationLog.length - 1] : null;
                    if (lastLog && lastLog.endTime === null) {
                        lastLog.endTime = totalSeconds;
                    }

                    gameSituationLog.push({
                        startTime: totalSeconds,
                        endTime: null,
                        situationA: currentSituationA,
                        situationB: currentSituationB
                    });

                    lastKnownSituations.A = currentSituationA;
                    lastKnownSituations.B = currentSituationB;
                }
            }
            
            const renderSituationBars = () => {
                const container = document.getElementById('timeline-situation-bars');
                if (!container) return;
                container.innerHTML = '';

                const situationColors = {
                    superiority: 'bg-green-500',
                    inferiority: 'bg-red-500',
                    seven_vs_six: 'bg-blue-500',
                    equality: 'bg-yellow-500'
                };

                if (gameSituationLog.length === 0) return;

                gameSituationLog.forEach(log => {
                    const startTime = log.startTime;
                    const endTime = log.endTime === null ? totalSeconds : log.endTime;
                    const duration = endTime - startTime;

                    if (duration <= 0) return;

                    const left = (startTime / 3600) * 100;
                    const width = (duration / 3600) * 100;

                    const barA = document.createElement('div');
                    barA.className = `absolute bottom-1/2 h-3 ${situationColors[log.situationA]} opacity-75`;
                    barA.style.left = `${left}%`;
                    barA.style.width = `${width}%`;
                    container.appendChild(barA);

                    const barB = document.createElement('div');
                    barB.className = `absolute top-1/2 h-3 ${situationColors[log.situationB]} opacity-75`;
                    barB.style.left = `${left}%`;
                    barB.style.width = `${width}%`;
                    container.appendChild(barB);
                });
            };

            const renderTimeline = () => {
                const containerA = document.getElementById('timeline-events-A');
                const containerB = document.getElementById('timeline-events-B');
                const markersContainer = document.getElementById('timeline-markers');
                if (!containerA || !containerB || !markersContainer) return;

                containerA.innerHTML = '';
                containerB.innerHTML = '';
                markersContainer.innerHTML = '';

                for (let i = 0; i <= 60; i += 5) {
                    const markerWrapper = document.createElement('div');
                    markerWrapper.className = 'flex flex-col items-center';
                    markerWrapper.style.position = 'absolute';
                    markerWrapper.style.left = `${(i / 60) * 100}%`;
                    markerWrapper.style.transform = 'translateX(-50%)';

                    const line = document.createElement('div');
                    line.className = 'h-2 w-0.5 bg-gray-500';
                    const label = document.createElement('span');
                    label.className = 'text-xs text-gray-400 mt-1';
                    label.textContent = i;

                    markerWrapper.appendChild(line);
                    markerWrapper.appendChild(label);
                    markersContainer.appendChild(markerWrapper);
                }

                const iconMap = {
                    goal: '⚽️',
                    save: '🧤',
                    miss: '🥅',
                    yellow_card: '🟨',
                    two_min: '⏱️',
                    red_card: '🟥'
                };

                gameEvents.forEach(event => {
                    const eventEl = document.createElement('div');
                    eventEl.className = 'timeline-event absolute transform -translate-x-1/2';
                    const leftPosition = (event.time / 3600) * 100;
                    eventEl.style.left = `${leftPosition}%`;

                    const icon = iconMap[event.type] || '❓';
                    const timeFormatted = formatTimeValue(event.time);
                    const tooltipText = `${timeFormatted} - ${event.details || event.type}`;

                    eventEl.innerHTML = `
                        <span class="text-xl cursor-pointer">${icon}</span>
                        <div class="timeline-tooltip">${tooltipText}</div>
                    `;

                    if (event.team === 'A') {
                        containerA.appendChild(eventEl);
                    } else {
                        containerB.appendChild(eventEl);
                    }
                });
                
                renderSituationBars();
            };

            // --- Modal Functions ---
            const showAlert = (message) => { alertText.textContent = message; alertModal.classList.remove('hidden'); };
            const showConfirm = (message, callback) => { modalText.textContent = message; confirmCallback = callback; confirmModal.classList.remove('hidden'); };
            const hideConfirm = () => { confirmModal.classList.add('hidden'); confirmCallback = null; };

            // --- Timer Functions ---
            const formatTimeValue = (timeInSeconds) => `${Math.floor(timeInSeconds / 60).toString().padStart(2, '0')}:${(timeInSeconds % 60).toString().padStart(2, '0')}`;
            
            const updateSituationButtonsState = () => {
                if (gameData.B.isSuspended) {
                    opponent7v6Btn.disabled = true;
                    opponent7v6Btn.classList.add('opacity-50', 'cursor-not-allowed');
                    if (isOpponent7v6) {
                        isOpponent7v6 = false;
                        opponent7v6Btn.classList.remove('opponent-7v6-active');
                        opponent7v6Btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                        checkAndLogSituationChange();
                        renderTimeline();
                    }
                } else {
                    opponent7v6Btn.disabled = false;
                    opponent7v6Btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            };

            const updateSuspensionTimers = () => {
                let needsRender = false;
                let situationChanged = false;

                gameData.A.players.forEach(p => {
                    if (p.isSuspended && p.suspensionTimer > 0) {
                        p.suspensionTimer--;
                        if (p.suspensionTimer === 0) {
                            p.isSuspended = false;
                            situationChanged = true;
                        }
                        needsRender = true;
                    }
                });
                if (gameData.A.isTeamSuspended && gameData.A.teamSuspensionTimer > 0) {
                    gameData.A.teamSuspensionTimer--;
                    if (gameData.A.teamSuspensionTimer === 0) {
                        gameData.A.isTeamSuspended = false;
                        situationChanged = true;
                    }
                    needsRender = true;
                }
                if (gameData.B.isSuspended && gameData.B.suspensionTimer > 0) {
                    gameData.B.suspensionTimer--;
                    if (gameData.B.suspensionTimer === 0) {
                        gameData.B.isSuspended = false;
                        situationChanged = true;
                        updateSituationButtonsState(); 
                    }
                    needsRender = true;
                }
                if (needsRender) renderPlayers();
                if (situationChanged) {
                    checkAndLogSituationChange();
                    renderTimeline();
                }
            };
            const updatePlayersTimeOnCourt = () => {
                if (!isTimerRunning) return;
                gameData.A.players.forEach(player => {
                    if (player.onCourt) {
                        player.timeOnCourt++;
                        const timeEl = document.getElementById(`player-time-A-${player.Numero}`);
                        if (timeEl) timeEl.textContent = formatTimeValue(player.timeOnCourt);
                    }
                });
            };
            const startTimer = () => {
                if (!isTimerRunning && totalSeconds < SECOND_HALF_END) {
                    isTimerRunning = true;
                    startBtn.disabled = true;
                    startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    openCorrectionModalBtn.classList.add('hidden');

                    timerInterval = setInterval(() => {
                        totalSeconds++;
                        timerDisplay.textContent = formatTimeValue(totalSeconds);
                        updatePlayersTimeOnCourt();
                        updateSuspensionTimers();
                        renderTimeline();

                        if (totalSeconds === FIRST_HALF_END && currentGamePart === 1) {
                            pauseTimer();
                            showAlert('Fim da Primeira Parte');
                            currentGamePart = 2;
                            gamePartDisplay.textContent = '2ª Parte';
                        } else if (totalSeconds >= SECOND_HALF_END) {
                            totalSeconds = SECOND_HALF_END;
                            timerDisplay.textContent = formatTimeValue(totalSeconds);
                            pauseTimer();
                            showAlert('Fim de Jogo');
                            startBtn.disabled = true;
                            startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                        }
                    }, 1000);
                    startBtn.textContent = 'Continuar';
                    saveGameState();
                }
            };
            const pauseTimer = () => {
                isTimerRunning = false;
                clearInterval(timerInterval);
                checkAndLogSituationChange();
                renderTimeline();
                if (totalSeconds < SECOND_HALF_END) {
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    openCorrectionModalBtn.classList.remove('hidden');
                }
                saveGameState();
            };
            
            const openCorrectionModal = () => {
                const currentMinutes = Math.floor(totalSeconds / 60);
                const currentSeconds = totalSeconds % 60;
                document.getElementById('correctMinutes').value = currentMinutes;
                document.getElementById('correctSeconds').value = currentSeconds;
                correctionModal.classList.remove('hidden');
            };
            const closeCorrectionModal = () => {
                correctionModal.classList.add('hidden');
            };
            
            // Player Management
            const updateGameSituationDisplay = () => {
                const situationTextMap = {
                    superiority: '(Superioridade)',
                    inferiority: '(Inferioridade)',
                    seven_vs_six: '(7x6)',
                    equality: '(Igualdade)'
                };
                const situationColorMap = {
                    superiority: 'text-green-400',
                    inferiority: 'text-red-500',
                    seven_vs_six: 'text-blue-400',
                    equality: 'text-gray-400'
                };
                const currentSituationA = getSituationA();
                gameSituationDisplay.textContent = situationTextMap[currentSituationA] || '(Igualdade)';
                gameSituationDisplay.className = `text-sm font-semibold ${situationColorMap[currentSituationA]}`;
            };
            const updatePlayerCountAndCheckStart = () => {
                const onCourtPlayersA = gameData.A.players.filter(p => p.onCourt).length;
                playerCountADisplay.textContent = `${onCourtPlayersA}/7`;
                
                if (totalSeconds === 0) {
                    if (onCourtPlayersA === 7) {
                        playerCountADisplay.classList.remove('text-red-400');
                        playerCountADisplay.classList.add('text-green-400');
                        startBtn.disabled = false;
                        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        playerCountADisplay.classList.remove('text-green-400');
                        playerCountADisplay.classList.add('text-red-400');
                        startBtn.disabled = true;
                        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                } else {
                     const expectedPlayers = (gameData.A.isTeamSuspended || gameData.A.players.some(p => p.isSuspended)) ? 6 : 7;
                     if(onCourtPlayersA <= expectedPlayers) {
                         playerCountADisplay.classList.remove('text-red-400');
                         playerCountADisplay.classList.add('text-green-400');
                     } else {
                         playerCountADisplay.classList.remove('text-green-400');
                         playerCountADisplay.classList.add('text-red-400');
                     }
                }
            };

            const renderPlayers = () => {
                const goalkeeperList = document.getElementById('goalkeeper-list-A');
                const playerList = document.getElementById('player-list-A');
                goalkeeperList.innerHTML = '';
                playerList.innerHTML = '';

                if (gameData.A.isTeamSuspended) {
                    teamSuspensionDisplay.textContent = `(Equipa c/ -1: ${formatTimeValue(gameData.A.teamSuspensionTimer)})`;
                } else {
                    teamSuspensionDisplay.textContent = '';
                }

                if (gameData.B.isSuspended) {
                    opponentTeamSuspensionDisplay.textContent = `(Adv. c/ -1: ${formatTimeValue(gameData.B.suspensionTimer)})`;
                } else {
                    opponentTeamSuspensionDisplay.textContent = '';
                }

                const createPlayerElement = (player) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = `flex items-center justify-between p-2 rounded-lg ${player.onCourt ? 'bg-green-900' : 'bg-gray-700'}`;
                    
                    let actionButtonHTML = '';
                    if (player.isGoalkeeper) {
                        actionButtonHTML = `
                            <button data-player-number="${player.Numero}" class="gk-shoot-btn btn-feedback text-xs font-bold py-1 px-1 rounded-full bg-blue-500 text-white ${player.onCourt ? '' : 'hidden'}">Remate</button>
                            <button data-player-number="${player.Numero}" class="gk-shot-btn btn-feedback text-xs font-bold py-1 px-1 rounded-full bg-red-500 text-white ${player.onCourt ? '' : 'hidden'}">Rem. Sofrido</button>
                        `;
                    } else {
                        actionButtonHTML = `<button data-player-number="${player.Numero}" class="shot-btn btn-feedback text-xs font-bold py-1 px-2 rounded-full bg-blue-500 text-white ${player.onCourt ? '' : 'hidden'}">Remate</button>`;
                    }

                    let sanctionDisplay = '';
                    if (player.sanctions.red > 0) sanctionDisplay = '🟥';
                    else if (player.isSuspended) sanctionDisplay = `<span class="font-mono text-orange-400">${formatTimeValue(player.suspensionTimer)}</span>`;
                    else if (player.sanctions.yellow > 0) sanctionDisplay = '🟨';
                    
                    const isBlocked = player.isSuspended || player.sanctions.red > 0;

                    const finalScore = player.finalScore;
                    const scoreClass = finalScore > 25 ? 'text-green-400' : finalScore < 0 ? 'text-red-400' : 'text-gray-400';

                    playerDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-400 w-8">${player.Numero}</span>
                            <span class="font-medium">${player.Nome}</span>
                            <span class="w-12 text-center">${sanctionDisplay}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold ${scoreClass} w-10 text-center">${finalScore}</span>
                            <span id="player-time-A-${player.Numero}" class="font-mono text-sm text-gray-300 w-12">${formatTimeValue(player.timeOnCourt)}</span>
                            ${actionButtonHTML}
                            <button data-player-number="${player.Numero}" class="positive-action-btn btn-feedback text-xs font-bold py-1 px-1 rounded-full bg-teal-500 text-white ${player.onCourt ? '' : 'hidden'}">Ação Pos.</button>
                            <button data-player-number="${player.Numero}" class="negative-action-btn btn-feedback text-xs font-bold py-1 px-1 rounded-full bg-yellow-500 text-black ${player.onCourt ? '' : 'hidden'}">Ação Neg.</button>
                            <button data-player-number="${player.Numero}" class="toggle-status-btn btn-feedback text-xs font-bold py-1 px-2 rounded-full ${player.onCourt ? 'bg-gray-200 text-black' : 'bg-green-500 text-white'} ${isBlocked ? 'opacity-50 cursor-not-allowed' : ''}" ${isBlocked ? 'disabled' : ''}>${player.onCourt ? 'Banco' : 'Campo'}</button>
                        </div>`;
                    return playerDiv;
                };

                gameData.A.players.forEach(player => {
                    if (player.isGoalkeeper) {
                        goalkeeperList.appendChild(createPlayerElement(player));
                    } else {
                        playerList.appendChild(createPlayerElement(player));
                    }
                });
                updatePlayerCountAndCheckStart();
                updateGameSituationDisplay();
            };
            
            const renderOfficials = () => {
                const officialsContainer = document.getElementById('officials-list-A');
                officialsContainer.innerHTML = '';
                gameData.A.officials.forEach(official => {
                    const officialDiv = document.createElement('div');
                    officialDiv.className = 'flex items-center justify-between p-2 rounded-lg bg-gray-700';
                    let sanctionDisplay = '';
                    if (official.sanctions.red > 0) sanctionDisplay = '🟥';
                    else if (official.sanctions.twoMin > 0) sanctionDisplay = '<span class="text-orange-400">2\'</span>';
                    else if (official.sanctions.yellow > 0) sanctionDisplay = '🟨';

                    officialDiv.innerHTML = `
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-gray-400 w-8">${official.Posicao}</span>
                            <span class="font-medium">${official.Nome}</span>
                            <span class="w-8 text-center">${sanctionDisplay}</span>
                        </div>
                        <button data-official-name="${official.Nome}" class="official-sanction-btn btn-feedback text-xs font-bold py-1 px-2 rounded-full bg-red-500 text-white">Sanção</button>
                    `;
                    officialsContainer.appendChild(officialDiv);
                });
            };

            // File Handling and Initial Setup
            const checkStartConditions = () => {
                const teamBName = document.getElementById('welcome-team-b-name').value.trim();
                startGameBtn.disabled = !(gameData.A.fileLoaded && teamBName !== '');
            };

            const handleFileSelect = (evt) => {
                const file = evt.target.files[0];
                if (!file) return;
                document.getElementById('file-name-A').textContent = file.name;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const athletesSheetName = workbook.SheetNames[0];
                    const athletesWorksheet = workbook.Sheets[athletesSheetName];
                    const athletesJson = XLSX.utils.sheet_to_json(athletesWorksheet);
                    gameData.A.players = athletesJson
                        .filter(p => p.Numero && p.Nome && p.Posicao)
                        .map(p => ({ 
                            ...p, 
                            goals: 0, 
                            performanceScore: 0, 
                            finalScore: 0, 
                            onCourt: false, 
                            timeOnCourt: 0, 
                            shots: [], 
                            shotsFaced: [], 
                            negativeActions: [], 
                            positiveActions: [], 
                            sanctions: { yellow: 0, twoMin: 0, red: 0 }, 
                            isSuspended: false, 
                            suspensionTimer: 0, 
                            isGoalkeeper: p.Posicao.trim().toUpperCase() === 'GR',
                            plusMinus: 0,
                            goalsForWhileOnCourt: 0,
                            goalsAgainstWhileOnCourt: 0
                        }));

                    if (workbook.SheetNames.length > 1) {
                        const officialsSheetName = workbook.SheetNames[1];
                        const officialsWorksheet = workbook.Sheets[officialsSheetName];
                        gameData.A.officials = XLSX.utils.sheet_to_json(officialsWorksheet)
                            .filter(o => o.Nome && o.Posicao)
                            .map(o => ({...o, sanctions: { yellow: 0, twoMin: 0, red: 0 } }));
                    }

                    gameData.A.fileLoaded = true;
                    checkStartConditions();
                };
                reader.readAsArrayBuffer(file);
            };
            
            const deactivatePassivePlay = () => {
                if (isPassivePlay) {
                    isPassivePlay = false;
                    passivePlayBtn.classList.remove('passive-active');
                    passivePlayBtn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                }
            };
            
            const deactivateOpponent7v6 = () => {
                if (isOpponent7v6) {
                    isOpponent7v6 = false;
                    opponent7v6Btn.classList.remove('opponent-7v6-active');
                    opponent7v6Btn.classList.add('bg-gray-700', 'hover:bg-gray-600');
                    checkAndLogSituationChange();
                    renderTimeline();
                }
            };

            // Modals Logic
            const shotZoneRules = { 'Ponta': [1, 5], 'Pivot': [2, 3, 4], 'Penetração': [2, 3, 4], '6mt': [2, 3, 4], '9mt': [6, 7, 8], '7mt': [], '1ª Vaga': [1, 2, 3, 4, 5, 6, 7, 8], '2ª Vaga': [1, 2, 3, 4, 5, 6, 7, 8], '3ª Vaga': [1, 2, 3, 4, 5, 6, 7, 8], 'Após Golo': [1, 2, 3, 4, 5, 6, 7, 8], 'Baliza Aberta': [] };
            const openShotModal = (player, mode) => { 
                currentPersonForAction = player; 
                document.getElementById('shotPlayerName').textContent = `#${player.Numero} ${player.Nome}`; 
                
                if(mode === 'gk_shoot') {
                    isGkShot = false;
                    document.getElementById('shotModalTitle').textContent = 'Remate (Baliza Aberta)';
                    document.getElementById('shot-types-container-wrapper').classList.add('hidden');
                    document.getElementById('shot-zone-container').classList.add('hidden');
                    document.getElementById('shot-outcome-title').textContent = 'Resultado do Remate';
                    document.querySelectorAll('.shot-outcome-btn').forEach(b => b.disabled = false);
                    selectedShotType = 'Baliza Aberta';
                } else {
                    isGkShot = (mode === 'gk_faced');
                    document.getElementById('shotModalTitle').textContent = isGkShot ? 'Registar Remate Sofrido' : 'Registar Remate';
                    document.getElementById('shot-types-container-wrapper').classList.remove('hidden');
                }
                shotModal.classList.remove('hidden'); 
            };
            const closeShotModal = () => { shotModal.classList.add('hidden'); currentPersonForAction = null; selectedShotType = null; selectedShotZone = null; isGkShot = false; document.querySelectorAll('.shot-type-btn.selected, .shot-zone-btn.selected').forEach(btn => btn.classList.remove('selected')); document.querySelectorAll('.shot-outcome-btn').forEach(btn => btn.disabled = true); document.getElementById('shot-zone-container').classList.add('hidden'); };
            
            const openNegativeActionModal = (player) => { currentPersonForAction = player; document.getElementById('negativeActionPlayerName').textContent = `#${player.Numero} ${player.Nome}`; negativeActionModal.classList.remove('hidden'); };
            const closeNegativeActionModal = () => { negativeActionModal.classList.add('hidden'); currentPersonForAction = null; };
            
            const openPositiveActionModal = (player) => { 
                currentPersonForAction = player; 
                document.getElementById('positiveActionPlayerName').textContent = `#${player.Numero} ${player.Nome}`; 
                const stealButton = document.querySelector('#positiveActionModal [data-positive-action="steal"]'); 
                const sevenMeterButton = document.querySelector('#positiveActionModal [data-positive-action="7m_provoked"]'); 
                const twoMinSevenMeterButton = document.querySelector('#positiveActionModal [data-positive-action="2min_7m_provoked"]'); 
                const assistButton = document.querySelector('#positiveActionModal [data-positive-action="assist"]');

                if (player.isGoalkeeper) { 
                    stealButton.style.display = 'none'; 
                    sevenMeterButton.style.display = 'none'; 
                    twoMinSevenMeterButton.style.display = 'none'; 
                    assistButton.style.display = 'none';
                } else { 
                    stealButton.style.display = 'block'; 
                    sevenMeterButton.style.display = 'block'; 
                    twoMinSevenMeterButton.style.display = 'block'; 
                    assistButton.style.display = 'block';
                } 
                positiveActionModal.classList.remove('hidden'); 
            };
            const closePositiveActionModal = () => { positiveActionModal.classList.add('hidden'); currentPersonForAction = null; };
            
            const triggerTeamSuspension = (callback) => { 
                const onCourtPlayers = gameData.A.players.filter(p => p.onCourt);
                if (onCourtPlayers.length > 0) {
                    openRemovePlayerModal(onCourtPlayers, () => {
                        gameData.A.isTeamSuspended = true; 
                        gameData.A.teamSuspensionTimer = 120;
                        if(callback) callback();
                        checkAndLogSituationChange();
                        renderTimeline();
                    });
                } else {
                    gameData.A.isTeamSuspended = true; 
                    gameData.A.teamSuspensionTimer = 120;
                    if(callback) callback();
                    checkAndLogSituationChange();
                    renderTimeline();
                }
            };
            const openSanctionsModal = (person, type) => { currentPersonForAction = {person, type}; document.getElementById('sanctionPlayerName').textContent = `${person.Nome}`; if(type === 'player'){ document.getElementById('sanctionYellow').disabled = person.sanctions.yellow > 0 || gameData.A.teamYellowCards >= 3; document.getElementById('sanction2Min').disabled = person.sanctions.twoMin >= 3 || person.sanctions.red > 0; document.getElementById('sanctionRed').disabled = person.sanctions.red > 0; } else { document.getElementById('sanctionYellow').disabled = gameData.A.officialsSanctions.yellow > 0; document.getElementById('sanction2Min').disabled = gameData.A.officialsSanctions.twoMin > 0 || gameData.A.officialsSanctions.red > 0; document.getElementById('sanctionRed').disabled = gameData.A.officialsSanctions.red > 0; } sanctionsModal.classList.remove('hidden'); };
            const closeSanctionsModal = () => { sanctionsModal.classList.add('hidden'); currentPersonForAction = null; };
            
            const openRemovePlayerModal = (players, callback) => {
                const listContainer = document.getElementById('remove-player-list');
                listContainer.innerHTML = '';
                players.forEach(p => {
                    const btn = document.createElement('button');
                    btn.className = 'w-full text-left p-2 bg-gray-700 hover:bg-gray-600 rounded-lg';
                    btn.textContent = `#${p.Numero} ${p.Nome}`;
                    btn.onclick = () => {
                        p.onCourt = false;
                        if(callback) callback();
                        closeRemovePlayerModal();
                        renderPlayers();
                    };
                    listContainer.appendChild(btn);
                });
                actionAfterPlayerRemoval = callback;
                removePlayerModal.classList.remove('hidden');
            };
            const closeRemovePlayerModal = () => {
                removePlayerModal.classList.add('hidden');
            };
            
            // UI Update Functions
            const updateUI = () => {
                const statsA = gameData.A.stats, statsB = gameData.B.stats;
                document.getElementById('scoreA').textContent = statsA.goals;
                document.getElementById('scoreB').textContent = statsB.goals;
                const totalShotsA = statsA.goals + statsA.misses + statsA.savedShots;
                const totalShotsB = statsB.goals + statsB.misses + statsB.savedShots;
                document.getElementById('shotsA').textContent = totalShotsA;
                document.getElementById('shotsB').textContent = totalShotsB;
                const techFaultsA = gameData.A.players.reduce((acc, p) => acc + p.negativeActions.filter(a => a.action === 'technical_fault').length, 0);
                const attacksA = totalShotsA + gameData.A.stats.turnovers + techFaultsA;
                const attacksB = totalShotsB + gameData.B.stats.turnovers + gameData.B.stats.technical_faults;
                document.getElementById('effA').textContent = `${attacksA > 0 ? ((statsA.goals / attacksA) * 100).toFixed(1) : '0.0'}%`;
                document.getElementById('effB').textContent = `${attacksB > 0 ? ((statsB.goals / attacksB) * 100).toFixed(1) : '0.0'}%`;
                document.getElementById('savesA').textContent = statsA.gkSaves;
                document.getElementById('savesB').textContent = statsB.gkSaves;
                
                const totalPerformanceScoreA = gameData.A.players.reduce((acc, p) => acc + p.performanceScore, 0);
                document.getElementById('performanceScoreA').textContent = totalPerformanceScoreA;

                const teamAName = document.getElementById('teamAName').value;
                const teamBName = document.getElementById('teamBName').value;
                document.getElementById('statsTeamAName').textContent = teamAName;
                document.getElementById('statsTeamBName').textContent = teamBName;

                if (gameData.B.isSuspended) {
                    opponentTeamSuspensionDisplay.textContent = `(Adv. c/ -1: ${formatTimeValue(gameData.B.suspensionTimer)})`;
                } else {
                    opponentTeamSuspensionDisplay.textContent = '';
                }
                renderTeamStats();
                saveGameState();
            };

            // Timeout Logic
            const handleTimeout = (team) => {
                const teamTimeouts = gameData[team].timeouts;
                
                if (teamTimeouts.total <= 0) {
                    showAlert('Não tem mais time-outs disponíveis.');
                    return;
                }
                if (currentGamePart === 1 && teamTimeouts.part1 >= 2) {
                    showAlert('Só pode pedir 2 time-outs na primeira parte.');
                    return;
                }
                if (currentGamePart === 2 && teamTimeouts.part2 >= 2) {
                    showAlert('Só pode pedir 2 time-outs na segunda parte.');
                    return;
                }
                if (currentGamePart === 2 && totalSeconds >= (25 * 60) && teamTimeouts.part2 >= 1) {
                    showAlert('Só pode pedir 1 time-out nos últimos 5 minutos.');
                    return;
                }
                
                pauseTimer();
                
                teamTimeouts.total--;
                if (currentGamePart === 1) teamTimeouts.part1++;
                else teamTimeouts.part2++;
                
                teamTimeouts.taken.push(totalSeconds);
                document.getElementById(`timeout-count-${team}`).textContent = teamTimeouts.total;

                let timeoutSeconds = 57;
                timeoutTimerDisplay.classList.remove('hidden');
                
                timeoutTitle.classList.remove('text-blue-400', 'text-orange-400');
                timeoutTimer.classList.remove('text-blue-400', 'text-orange-400');

                if (team === 'A') {
                    timeoutTitle.classList.add('text-blue-400');
                    timeoutTimer.classList.add('text-blue-400');
                } else {
                    timeoutTitle.classList.add('text-orange-400');
                    timeoutTimer.classList.add('text-orange-400');
                }

                timeoutTimer.textContent = formatTimeValue(timeoutSeconds);
                
                startBtn.disabled = true;
                pauseBtn.disabled = true;
                openCorrectionModalBtn.disabled = true;
                timeoutBtnA.disabled = true;
                timeoutBtnB.disabled = true;

                timeoutInterval = setInterval(() => {
                    timeoutSeconds--;
                    timeoutTimer.textContent = formatTimeValue(timeoutSeconds);
                    if (timeoutSeconds <= 0) {
                        clearInterval(timeoutInterval);
                        timeoutTimerDisplay.classList.add('hidden');
                        startBtn.disabled = false;
                        pauseBtn.disabled = false;
                        openCorrectionModalBtn.disabled = false;
                        timeoutBtnA.disabled = false;
                        timeoutBtnB.disabled = false;
                    }
                }, 1000);
                saveGameState();
            };
            
            // --- Team Stats Logic ---
            const renderTeamStats = () => {
                const container = document.getElementById('team-stats-content');
                if (!container) return;

                const createStatRow = (label, valueA, barPercentA, valueB, barPercentB, isPercentage = true) => {
                    const valueADisplay = isPercentage ? `${barPercentA.toFixed(1)}%` : valueA;
                    const valueBDisplay = isPercentage ? `${barPercentB.toFixed(1)}%` : valueB;

                    return `
                        <div class="grid grid-cols-[1fr_3fr_2fr_3fr_1fr] items-center gap-x-3 text-center">
                            <span class="font-semibold text-blue-400 text-sm md:text-base">${valueADisplay}</span>
                            <div class="bg-gray-700 rounded-full h-4 w-full">
                                <div class="bg-blue-500 h-4 rounded-full" style="width: ${barPercentA}%;"></div>
                            </div>
                            <span class="font-semibold text-gray-300 text-xs md:text-sm">${label}</span>
                            <div class="bg-gray-700 rounded-full h-4 w-full">
                                <div class="bg-orange-500 h-4 rounded-full" style="width: ${barPercentB}%;"></div>
                            </div>
                            <span class="font-semibold text-orange-400 text-sm md:text-base">${valueBDisplay}</span>
                        </div>
                    `;
                };

                const goalsA = gameData.A.stats.goals;
                const totalShotsA = goalsA + gameData.A.stats.misses + gameData.A.stats.savedShots;
                const techFaultsA = gameData.A.players.reduce((acc, p) => acc + p.negativeActions.filter(a => a.action === 'technical_fault').length, 0);
                const attacksA = totalShotsA + gameData.A.stats.turnovers + techFaultsA;
                const effOfensivaA = attacksA > 0 ? (goalsA / attacksA) * 100 : 0;
                const shotsFacedA = gameData.A.stats.gkSaves + gameData.A.stats.gkGoalsAgainst;
                const effGKA = shotsFacedA > 0 ? (gameData.A.stats.gkSaves / shotsFacedA) * 100 : 0;
                const goalsEqualityA = gameData.A.players.reduce((acc, p) => acc + p.shots.filter(s => s.outcome === 'goal' && s.situationA === 'equality').length, 0);
                const goalsInferiorityA = gameData.A.players.reduce((acc, p) => acc + p.shots.filter(s => s.outcome === 'goal' && s.situationA === 'inferiority').length, 0);
                const goalsSuperiorityA = gameData.A.players.reduce((acc, p) => acc + p.shots.filter(s => s.outcome === 'goal' && s.situationA === 'superiority').length, 0);
                const goals7v6A = gameData.A.players.reduce((acc, p) => acc + p.shots.filter(s => s.outcome === 'goal' && s.situationA === 'seven_vs_six').length, 0);
                const goalsTransitionA = gameData.A.players.reduce((acc, p) => acc + p.shots.filter(s => s.outcome === 'goal' && ['1ª Vaga', '2ª Vaga', '3ª Vaga', 'Após Golo'].includes(s.type)).length, 0);

                const goalsB = gameData.B.stats.goals;
                const totalShotsB = goalsB + gameData.B.stats.misses + gameData.B.stats.savedShots;
                const techFaultsB = gameData.B.stats.technical_faults;
                const attacksB = totalShotsB + gameData.B.stats.turnovers + techFaultsB;
                const effOfensivaB = attacksB > 0 ? (goalsB / attacksB) * 100 : 0;
                const shotsFacedB = gameData.B.stats.gkSaves + goalsA;
                const effGKB = shotsFacedB > 0 ? (gameData.B.stats.gkSaves / shotsFacedB) * 100 : 0;
                const goalsEqualityB = gameData.A.players.reduce((acc, p) => acc + p.shotsFaced.filter(s => s.outcome === 'goal' && s.situationB === 'equality').length, 0);
                const goalsInferiorityB = gameData.A.players.reduce((acc, p) => acc + p.shotsFaced.filter(s => s.outcome === 'goal' && s.situationB === 'inferiority').length, 0);
                const goalsSuperiorityB = gameData.A.players.reduce((acc, p) => acc + p.shotsFaced.filter(s => s.outcome === 'goal' && s.situationB === 'superiority').length, 0);
                const goals7v6B = gameData.A.players.reduce((acc, p) => acc + p.shotsFaced.filter(s => s.outcome === 'goal' && s.situationB === 'seven_vs_six').length, 0);
                const goalsTransitionB = gameData.A.players.reduce((acc, p) => acc + p.shotsFaced.filter(s => s.outcome === 'goal' && ['1ª Vaga', '2ª Vaga', '3ª Vaga', 'Após Golo'].includes(s.type)).length, 0);
                
                let html = '';
                html += createStatRow('Golos', goalsA, totalShotsA > 0 ? (goalsA / totalShotsA) * 100 : 0, goalsB, totalShotsB > 0 ? (goalsB / totalShotsB) * 100 : 0, false);
                html += createStatRow('Eficácia Ofensiva', effOfensivaA, effOfensivaA, effOfensivaB, effOfensivaB);
                html += createStatRow('Eficácia GR', effGKA, effGKA, effGKB, effGKB);
                html += createStatRow('Golos em Igualdade', goalsEqualityA, goalsA > 0 ? (goalsEqualityA / goalsA) * 100 : 0, goalsEqualityB, goalsB > 0 ? (goalsEqualityB / goalsB) * 100 : 0, false);
                html += createStatRow('Golos em Inferioridade', goalsInferiorityA, goalsA > 0 ? (goalsInferiorityA / goalsA) * 100 : 0, goalsInferiorityB, goalsB > 0 ? (goalsInferiorityB / goalsB) * 100 : 0, false);
                html += createStatRow('Golos em Superioridade', goalsSuperiorityA, goalsA > 0 ? (goalsSuperiorityA / goalsA) * 100 : 0, goalsSuperiorityB, goalsB > 0 ? (goalsSuperiorityB / goalsB) * 100 : 0, false);
                html += createStatRow('Golos 7x6', goals7v6A, goalsA > 0 ? (goals7v6A / goalsA) * 100 : 0, goals7v6B, goalsB > 0 ? (goals7v6B / goalsB) * 100 : 0, false);
                html += createStatRow('Golos em Transição', goalsTransitionA, goalsA > 0 ? (goalsTransitionA / goalsA) * 100 : 0, goalsTransitionB, goalsB > 0 ? (goalsTransitionB / goalsB) * 100 : 0, false);
                html += createStatRow('Falhas Técnicas', techFaultsA, attacksA > 0 ? (techFaultsA / attacksA) * 100 : 0, techFaultsB, attacksB > 0 ? (techFaultsB / attacksB) * 100 : 0, false);

                container.innerHTML = html;
            }

            // --- Individual Stats Logic ---
            const renderIndividualStats = () => {
                const playerSelect = document.getElementById('player-stats-select');
                if (!playerSelect) return;

                const currentPlayerNumber = playerSelect.value || 'all';
                playerSelect.innerHTML = '<option value="all">Toda a Equipa</option>';
                gameData.A.players.forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.Numero;
                    option.textContent = `#${player.Numero} ${player.Nome}`;
                    playerSelect.appendChild(option);
                });
                playerSelect.value = currentPlayerNumber;

                updateIndividualDashboard(currentPlayerNumber);
            };

            const handleIndividualStatChange = (e) => {
                updateIndividualDashboard(e.target.value);
            };

            const updateIndividualDashboard = (playerNumber) => {
                const kpiContainer = document.getElementById('individual-kpis');
                const tableBody = document.getElementById('individual-stats-table');
                if (!kpiContainer || !tableBody) return;

                let playersToAnalyze = [];
                if (playerNumber === 'all') {
                    playersToAnalyze = gameData.A.players;
                } else {
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) {
                        playersToAnalyze.push(player);
                    }
                }

                if (playersToAnalyze.length === 0) {
                    kpiContainer.innerHTML = '';
                    tableBody.innerHTML = '';
                    d3.select("#shot-distribution-chart").selectAll("*").remove();
                    d3.select("#shot-efficiency-chart").selectAll("*").remove();
                    return;
                }

                // Aggregate stats for the selected player(s)
                const totalStats = {
                    performanceScore: playersToAnalyze.reduce((sum, p) => sum + p.performanceScore, 0),
                    finalScore: playerNumber !== 'all' ? playersToAnalyze[0].finalScore : 'N/A',
                    shots: playersToAnalyze.flatMap(p => p.shots),
                    positiveActions: playersToAnalyze.flatMap(p => p.positiveActions),
                    negativeActions: playersToAnalyze.flatMap(p => p.negativeActions),
                    timeOnCourt: playersToAnalyze.reduce((sum, p) => sum + p.timeOnCourt, 0),
                    sanctions: {
                        yellow: playersToAnalyze.reduce((sum, p) => sum + p.sanctions.yellow, 0),
                        twoMin: playersToAnalyze.reduce((sum, p) => sum + p.sanctions.twoMin, 0),
                        red: playersToAnalyze.reduce((sum, p) => sum + p.sanctions.red, 0),
                    }
                };

                const totalShots = totalStats.shots.length;
                const totalGoals = totalStats.shots.filter(s => s.outcome === 'goal').length;
                const shotEfficiency = totalShots > 0 ? (totalGoals / totalShots) * 100 : 0;
                
                // Render KPIs
                kpiContainer.innerHTML = `
                    <div class="bg-gray-900 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Pontuação Final</p>
                        <p class="text-3xl font-bold text-yellow-400">${totalStats.finalScore}</p>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Eficácia Remate</p>
                        <p class="text-3xl font-bold">${shotEfficiency.toFixed(1)}%</p>
                        <p class="text-xs text-gray-500">(${totalGoals}/${totalShots})</p>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Ações Positivas</p>
                        <p class="text-3xl font-bold text-green-500">${totalStats.positiveActions.length}</p>
                    </div>
                    <div class="bg-gray-900 p-4 rounded-lg text-center">
                        <p class="text-sm text-gray-400">Ações Negativas</p>
                        <p class="text-3xl font-bold text-red-500">${totalStats.negativeActions.length}</p>
                    </div>
                `;

                // Render Table
                const techFaults = totalStats.negativeActions.filter(a => a.action === 'technical_fault').length;
                const turnovers = totalStats.negativeActions.filter(a => a.action === 'turnover').length;
                const assists = totalStats.positiveActions.filter(a => a.action === 'assist').length;

                tableBody.innerHTML = `
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-4 px-6 font-medium">Pontuação Base</td><td class="py-4 px-6 text-center">${totalStats.performanceScore}</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-4 px-6 font-medium">Tempo em Campo</td><td class="py-4 px-6 text-center">${formatTimeValue(totalStats.timeOnCourt)}</td>
                    </tr>
                     <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-4 px-6 font-medium">Assistências</td><td class="py-4 px-6 text-center">${assists}</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-4 px-6 font-medium">Faltas Técnicas</td><td class="py-4 px-6 text-center">${techFaults}</td>
                    </tr>
                    <tr class="bg-gray-800 border-b border-gray-700">
                        <td class="py-4 px-6 font-medium">Perdas de Bola</td><td class="py-4 px-6 text-center">${turnovers}</td>
                    </tr>
                    <tr class="bg-gray-800">
                        <td class="py-4 px-6 font-medium">Sanções</td><td class="py-4 px-6 text-center">🟨 ${totalStats.sanctions.yellow} | ⏱️ ${totalStats.sanctions.twoMin} | 🟥 ${totalStats.sanctions.red}</td>
                    </tr>
                `;

                // Render Charts
                renderShotDistributionChart(totalStats.shots);
                renderShotEfficiencyChart(totalStats.shots);
            };
            
            const renderShotDistributionChart = (shots) => {
                const shotCounts = d3.rollup(shots, v => v.length, d => d.type);
                const data = Array.from(shotCounts, ([key, value]) => ({type: key, count: value}));
                data.sort((a, b) => b.count - a.count);

                const container = d3.select("#shot-distribution-chart");
                container.selectAll("*").remove();

                if (data.length === 0) return;

                const margin = {top: 20, right: 20, bottom: 60, left: 40},
                      width = container.node().getBoundingClientRect().width - margin.left - margin.right,
                      height = 250 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                  .range([0, width])
                  .domain(data.map(d => d.type))
                  .padding(0.2);

                svg.append("g")
                  .attr("transform", `translate(0,${height})`)
                  .call(d3.axisBottom(x))
                  .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end")
                    .attr("class", "axis-label");

                const y = d3.scaleLinear()
                  .domain([0, d3.max(data, d => d.count) || 1])
                  .range([height, 0]);

                svg.append("g")
                  .call(d3.axisLeft(y).ticks(5))
                  .selectAll("text")
                  .attr("class", "axis-label");

                svg.selectAll(".bar")
                  .data(data)
                  .enter()
                  .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.type))
                    .attr("y", d => y(d.count))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d.count));
            };

            const renderShotEfficiencyChart = (shots) => {
                const efficiencyData = Array.from(d3.group(shots, d => d.type), ([key, value]) => {
                    const total = value.length;
                    const goals = value.filter(d => d.outcome === 'goal').length;
                    return { type: key, efficiency: total > 0 ? (goals / total) * 100 : 0, total: total };
                });
                efficiencyData.sort((a, b) => b.efficiency - a.efficiency);
                
                const container = d3.select("#shot-efficiency-chart");
                container.selectAll("*").remove();

                if (efficiencyData.length === 0) return;

                const margin = {top: 20, right: 20, bottom: 60, left: 40},
                      width = container.node().getBoundingClientRect().width - margin.left - margin.right,
                      height = 250 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand()
                  .range([0, width])
                  .domain(efficiencyData.map(d => d.type))
                  .padding(0.2);

                svg.append("g")
                  .attr("transform", `translate(0,${height})`)
                  .call(d3.axisBottom(x))
                  .selectAll("text")
                    .attr("transform", "translate(-10,0)rotate(-45)")
                    .style("text-anchor", "end")
                    .attr("class", "axis-label");

                const y = d3.scaleLinear()
                  .domain([0, 100])
                  .range([height, 0]);

                svg.append("g")
                  .call(d3.axisLeft(y).ticks(5).tickFormat(d => `${d}%`))
                  .selectAll("text")
                  .attr("class", "axis-label");

                svg.selectAll(".bar")
                  .data(efficiencyData)
                  .enter()
                  .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.type))
                    .attr("y", d => y(d.efficiency))
                    .attr("width", x.bandwidth())
                    .attr("height", d => height - y(d.efficiency));
            };
            
            // --- Team Stats Court Logic ---
            const updateTeamCourtStats = (situationFilter) => {
                let allShots = gameData.A.players.flatMap(p => p.shots);
                let shotsToAnalyze = [];

                if (situationFilter === 'all') {
                    shotsToAnalyze = allShots;
                } else if (situationFilter === 'passive') {
                    shotsToAnalyze = allShots.filter(s => s.passive);
                } else {
                    shotsToAnalyze = allShots.filter(s => s.situationA === situationFilter);
                }

                for (let i = 1; i <= 8; i++) {
                    const zoneShots = shotsToAnalyze.filter(s => s.zone == i);
                    const goals = zoneShots.filter(s => s.outcome === 'goal').length;
                    const total = zoneShots.length;
                    const efficiency = total > 0 ? (goals / total) * 100 : 0;
                    
                    const textElement = document.getElementById(`team-zone-${i}-stats`);
                    if (textElement) {
                        textElement.textContent = `${efficiency.toFixed(0)}% (${total})`;
                    }
                }
            };
            
            // --- Plus-Minus Logic ---
            const updatePlusMinusOnGoal = (isGoalForTeamA) => {
                gameData.A.players.forEach(p => {
                    if (p.onCourt) {
                        if (isGoalForTeamA) {
                            p.goalsForWhileOnCourt++;
                        } else {
                            p.goalsAgainstWhileOnCourt++;
                        }
                        p.plusMinus = p.goalsForWhileOnCourt - p.goalsAgainstWhileOnCourt;
                    }
                });
            };

            const renderPlusMinusTab = () => {
                const bestDiffContainer = document.getElementById('plus-minus-best-diff');
                const worstDiffContainer = document.getElementById('plus-minus-worst-diff');
                const mostGoalsForContainer = document.getElementById('plus-minus-most-goals-for');
                const mostGoalsAgainstContainer = document.getElementById('plus-minus-most-goals-against');

                const players = [...gameData.A.players];

                const sortedByBestDiff = players.sort((a, b) => b.plusMinus - a.plusMinus).slice(0, 7);
                const sortedByWorstDiff = players.sort((a, b) => a.plusMinus - b.plusMinus).slice(0, 7);
                const sortedByGoalsFor = players.sort((a, b) => b.goalsForWhileOnCourt - a.goalsForWhileOnCourt).slice(0, 7);
                const sortedByGoalsAgainst = players.sort((a, b) => b.goalsAgainstWhileOnCourt - a.goalsAgainstWhileOnCourt).slice(0, 7);

                renderPlayerList(bestDiffContainer, sortedByBestDiff, 'plusMinus', 'Saldo');
                renderPlayerList(worstDiffContainer, sortedByWorstDiff, 'plusMinus', 'Saldo');
                renderPlayerList(mostGoalsForContainer, sortedByGoalsFor, 'goalsForWhileOnCourt', 'Golos Marcados');
                renderPlayerList(mostGoalsAgainstContainer, sortedByGoalsAgainst, 'goalsAgainstWhileOnCourt', 'Golos Sofridos');
            };

            const renderPlayerList = (container, players, statKey, statLabel) => {
                container.innerHTML = '';
                if (players.length === 0 || players.every(p => p[statKey] === 0)) {
                    container.innerHTML = '<p class="text-gray-500 text-center">Ainda não há dados.</p>';
                    return;
                }
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                players.forEach(player => {
                    const value = player[statKey];
                    const colorClass = value > 0 ? 'text-green-400' : value < 0 ? 'text-red-400' : 'text-gray-300';
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-700 p-2 rounded-lg';
                    li.innerHTML = `
                        <span>#${player.Numero} ${player.Nome}</span>
                        <span class="font-bold ${colorClass}">${statLabel}: ${value}</span>
                    `;
                    list.appendChild(li);
                });
                container.appendChild(list);
            };


            // =================================================================
            // EVENT LISTENERS SETUP
            // =================================================================
            
            // --- Initial Setup ---
            document.getElementById('welcome-file-input-A').addEventListener('change', handleFileSelect);
            document.getElementById('welcome-team-b-name').addEventListener('input', checkStartConditions);
            startGameBtn.addEventListener('click', () => {
                document.getElementById('teamBName').value = document.getElementById('welcome-team-b-name').value.trim();
                updateUI();
                welcomeModal.classList.add('hidden');
                mainApp.classList.remove('hidden');
                gameSituationLog.push({ startTime: 0, endTime: null, situationA: 'equality', situationB: 'equality' });
                renderPlayers();
                renderOfficials();
                renderTimeline();
                saveGameState();
            });

            // --- Timer Controls ---
            startBtn.addEventListener('click', startTimer);
            pauseBtn.addEventListener('click', pauseTimer);
            document.getElementById('switchPartBtn').addEventListener('click', () => {
                currentGamePart = currentGamePart === 1 ? 2 : 1;
                gamePartDisplay.textContent = `${currentGamePart}ª Parte`;
                saveGameState();
            });
            openCorrectionModalBtn.addEventListener('click', openCorrectionModal);
            document.getElementById('closeCorrectionModalBtn').addEventListener('click', closeCorrectionModal);
            document.getElementById('setTimerBtn').addEventListener('click', () => {
                const minutes = parseInt(document.getElementById('correctMinutes').value, 10) || 0;
                const seconds = parseInt(document.getElementById('correctSeconds').value, 10) || 0;

                if (minutes >= 0 && seconds >= 0 && seconds < 60) {
                    const newTotalSeconds = (minutes * 60) + seconds;
                    const timeDifference = newTotalSeconds - totalSeconds;

                    gameData.A.players.forEach(player => {
                        if (player.onCourt) {
                            player.timeOnCourt += timeDifference;
                            if (player.timeOnCourt < 0) player.timeOnCourt = 0;
                        }
                        if (player.isSuspended && player.suspensionTimer > 0) {
                            player.suspensionTimer -= timeDifference;
                            if (player.suspensionTimer <= 0) {
                                player.suspensionTimer = 0;
                                player.isSuspended = false;
                            }
                        }
                    });

                    if (gameData.A.isTeamSuspended && gameData.A.teamSuspensionTimer > 0) {
                        gameData.A.teamSuspensionTimer -= timeDifference;
                        if (gameData.A.teamSuspensionTimer <= 0) {
                            gameData.A.teamSuspensionTimer = 0;
                            gameData.A.isTeamSuspended = false;
                        }
                    }
                    
                    if (gameData.B.isSuspended && gameData.B.suspensionTimer > 0) {
                        gameData.B.suspensionTimer -= timeDifference;
                        if (gameData.B.suspensionTimer <= 0) {
                            gameData.B.suspensionTimer = 0;
                            gameData.B.isSuspended = false;
                        }
                    }

                    totalSeconds = newTotalSeconds;
                    timerDisplay.textContent = formatTimeValue(totalSeconds);
                    
                    startBtn.disabled = false;
                    startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    renderPlayers();
                    closeCorrectionModal();
                    checkAndLogSituationChange();
                    renderTimeline();
                    saveGameState();
                }
            });

            // --- Game Situation Controls ---
            passivePlayBtn.addEventListener('click', () => {
                isPassivePlay = !isPassivePlay;
                passivePlayBtn.classList.toggle('passive-active');
                passivePlayBtn.classList.toggle('bg-gray-700');
                passivePlayBtn.classList.toggle('hover:bg-gray-600');
                saveGameState();
            });
            opponent7v6Btn.addEventListener('click', () => {
                isOpponent7v6 = !isOpponent7v6;
                opponent7v6Btn.classList.toggle('opponent-7v6-active');
                opponent7v6Btn.classList.toggle('bg-gray-700');
                opponent7v6Btn.classList.toggle('hover:bg-gray-600');
                checkAndLogSituationChange();
                renderPlayers();
                renderTimeline();
                saveGameState();
            });
            opponentTechFaultBtn.addEventListener('click', () => {
                gameData.B.stats.technical_faults++;
                updateUI();
                deactivatePassivePlay();
                deactivateOpponent7v6();
            });
            opponentOfficialSanctionBtn.addEventListener('click', () => {
                showConfirm('Registar uma sanção de 2 minutos para o adversário?', () => {
                    gameData.B.isSuspended = true;
                    gameData.B.suspensionTimer = 120;
                    logEvent('B', 'two_min', 'Adversário', totalSeconds, 'Sanção de 2 Minutos (Adversário)');
                    checkAndLogSituationChange();
                    updateUI();
                    renderTimeline();
                    updateSituationButtonsState();
                    deactivatePassivePlay();
                    deactivateOpponent7v6();
                });
            });

            // --- Main Click Listener for Dynamic Buttons ---
            document.addEventListener('click', (e) => {
                const target = e.target.closest('button'); // More robust
                if (!target) return;

                if (target.classList.contains('toggle-status-btn')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) {
                        const onCourtPlayersA = gameData.A.players.filter(p => p.onCourt).length;
                        const isAnyPlayerSuspended = gameData.A.players.some(p => p.isSuspended);
                        if ((isAnyPlayerSuspended || gameData.A.isTeamSuspended) && !player.onCourt) {
                            if (onCourtPlayersA < 6) {
                                player.onCourt = !player.onCourt;
                            } else {
                                showAlert('Não pode colocar um jogador em campo enquanto a equipa cumpre uma sanção.');
                                return;
                            }
                        } else if (onCourtPlayersA >= 7 && !player.onCourt) {
                            showAlert('Só é permitido ter 7 jogadores em campo');
                            return; 
                        } else {
                            player.onCourt = !player.onCourt;
                        }
                        checkAndLogSituationChange();
                        renderPlayers();
                        renderTimeline();
                        deactivatePassivePlay();
                        deactivateOpponent7v6();
                        saveGameState();
                    }
                } else if (target.classList.contains('shot-btn')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) openShotModal(player, 'field');
                } else if (target.classList.contains('gk-shot-btn')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) openShotModal(player, 'gk_faced');
                } else if (target.classList.contains('gk-shoot-btn')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) openShotModal(player, 'gk_shoot');
                } else if (target.classList.contains('negative-action-btn') && target.closest('#data-collection')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) openNegativeActionModal(player);
                } else if (target.classList.contains('positive-action-btn') && target.closest('#data-collection')) {
                    const playerNumber = target.dataset.playerNumber;
                    const player = gameData.A.players.find(p => p.Numero == playerNumber);
                    if (player) openPositiveActionModal(player);
                } else if (target.classList.contains('official-sanction-btn')) {
                    const officialName = target.dataset.officialName;
                    const official = gameData.A.officials.find(o => o.Nome == officialName);
                    if (official) openSanctionsModal(official, 'official');
                }
            });

            // --- Modal Event Listeners ---
            alertOkBtn.addEventListener('click', () => alertModal.classList.add('hidden'));
            confirmYesBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirm(); });
            confirmNoBtn.addEventListener('click', hideConfirm);
            document.getElementById('closeShotModalBtn').addEventListener('click', closeShotModal);
            document.querySelectorAll('.shot-type-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.shot-type-btn.selected').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); selectedShotType = btn.textContent; const validZones = shotZoneRules[selectedShotType]; document.querySelectorAll('.shot-zone-btn').forEach(zb => zb.classList.add('hidden')); document.querySelectorAll('.shot-outcome-btn').forEach(ob => ob.disabled = true); document.querySelectorAll('.shot-zone-btn.selected').forEach(b => b.classList.remove('selected')); if (validZones.length === 0) { document.getElementById('shot-zone-container').classList.add('hidden'); document.getElementById('shot-outcome-title').textContent = '2. Resultado do Remate'; document.querySelectorAll('.shot-outcome-btn').forEach(ob => ob.disabled = false); } else { document.getElementById('shot-zone-container').classList.remove('hidden'); document.getElementById('shot-outcome-title').textContent = '3. Resultado do Remate'; validZones.forEach(zoneNum => { document.querySelector(`.shot-zone-btn[data-zone='${zoneNum}']`).classList.remove('hidden'); }); } }); });
            document.querySelectorAll('.shot-zone-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelectorAll('.shot-zone-btn.selected').forEach(b => b.classList.remove('selected')); btn.classList.add('selected'); selectedShotZone = btn.dataset.zone; document.querySelectorAll('.shot-outcome-btn').forEach(ob => ob.disabled = false); }); });
            document.querySelectorAll('.shot-outcome-btn').forEach(btn => { btn.addEventListener('click', () => { if (!selectedShotType || !currentPersonForAction) return; if (shotZoneRules[selectedShotType].length > 0 && !selectedShotZone) return; const outcome = btn.dataset.outcome; const situationA = getSituationA(); const situationB = getSituationB(); const shotData = { type: selectedShotType, zone: selectedShotZone, outcome: outcome, time: totalSeconds, situationA: situationA, situationB: situationB, passive: isPassivePlay }; let points = 0; if (isGkShot) { currentPersonForAction.shotsFaced.push(shotData); points = pointSystem.goalkeeper.shot_faced[selectedShotType]?.[outcome] || 0; if (outcome === 'goal') { updatePlusMinusOnGoal(false); } switch(outcome) { case 'goal': gameData.A.stats.gkGoalsAgainst++; gameData.B.stats.goals++; if (['1ª Vaga', '2ª Vaga', '3ª Vaga', 'Após Golo'].includes(selectedShotType)) { gameData.B.stats.transition_goals++; } logEvent('B', 'goal', 'Adversário', totalSeconds, `Golo Sofrido: ${currentPersonForAction.Nome}`); break; case 'saved': gameData.A.stats.gkSaves++; gameData.B.stats.savedShots++; logEvent('A', 'save', currentPersonForAction.Nome, totalSeconds, `Defesa de GR: ${currentPersonForAction.Nome}`); break; case 'miss': case 'post': gameData.B.stats.misses++; logEvent('B', 'miss', 'Adversário', totalSeconds, `Remate Fora/Poste (Adv)`); break; } } else { currentPersonForAction.shots.push(shotData); const pointKey = outcome === 'goal' ? 'goal' : 'fail'; const playerType = currentPersonForAction.isGoalkeeper ? 'goalkeeper' : 'field_player'; if (playerType === 'goalkeeper') { points = pointSystem.goalkeeper.shot[pointKey] || 0; } else { points = pointSystem.field_player.shot[selectedShotType]?.[pointKey] || 0; } if (outcome === 'goal') { updatePlusMinusOnGoal(true); } switch(outcome) { case 'goal': gameData.A.stats.goals++; logEvent('A', 'goal', currentPersonForAction.Nome, totalSeconds, `Golo: ${currentPersonForAction.Nome}`); break; case 'saved': gameData.A.stats.savedShots++; if (selectedShotType !== 'Baliza Aberta') { gameData.B.stats.gkSaves++; } logEvent('B', 'save', 'GR Adversário', totalSeconds, `Remate de ${currentPersonForAction.Nome} defendido`); break; case 'miss': case 'post': gameData.A.stats.misses++; logEvent('A', 'miss', currentPersonForAction.Nome, totalSeconds, `Remate Fora/Poste: ${currentPersonForAction.Nome}`); break; } } updatePlayerScore(currentPersonForAction, points); updateUI(); renderPlayers(); closeShotModal(); deactivatePassivePlay(); deactivateOpponent7v6(); }); });
            document.getElementById('closeNegativeActionModalBtn').addEventListener('click', closeNegativeActionModal);
            document.querySelectorAll('#negativeActionModal .negative-action-btn').forEach(btn => { btn.addEventListener('click', () => { if (!currentPersonForAction) return; const action = btn.dataset.negativeAction; const playerType = currentPersonForAction.isGoalkeeper ? 'goalkeeper' : 'field_player'; let points = 0; if (action === 'sanction') { const personToSanction = currentPersonForAction; closeNegativeActionModal(); openSanctionsModal(personToSanction, 'player'); return; } if (action === '2min_7m_foul') { if (currentPersonForAction.sanctions.twoMin >= 3 || currentPersonForAction.sanctions.red > 0) { showAlert('Este jogador não pode receber mais exclusões de 2 minutos.'); return; } currentPersonForAction.sanctions.twoMin++; currentPersonForAction.isSuspended = true; currentPersonForAction.suspensionTimer = 120; currentPersonForAction.onCourt = false; points = pointSystem[playerType].negative_actions['2min_7m_foul'] || 0; if (currentPersonForAction.sanctions.twoMin >= 3) { currentPersonForAction.sanctions.red = 1; triggerTeamSuspension(); } } else { points = pointSystem[playerType].negative_actions[action] || 0; } currentPersonForAction.negativeActions.push({ action: action, time: totalSeconds }); if (action === 'turnover') { gameData.A.stats.turnovers++; } updatePlayerScore(currentPersonForAction, points); updateUI(); renderPlayers(); closeNegativeActionModal(); deactivatePassivePlay(); deactivateOpponent7v6(); }); });
            document.getElementById('closePositiveActionModalBtn').addEventListener('click', closePositiveActionModal);
            document.querySelectorAll('#positiveActionModal .positive-action-btn').forEach(btn => { btn.addEventListener('click', () => { if (!currentPersonForAction) return; const action = btn.dataset.positiveAction; const playerType = currentPersonForAction.isGoalkeeper ? 'goalkeeper' : 'field_player'; currentPersonForAction.positiveActions.push({ action: action, time: totalSeconds }); const points = pointSystem[playerType].positive_actions[action] || 0; updatePlayerScore(currentPersonForAction, points); if (action === 'steal') { gameData.B.stats.turnovers++; } if (action === '2min_provoked' || action === '2min_7m_provoked') { gameData.B.isSuspended = true; gameData.B.suspensionTimer = 120; checkAndLogSituationChange(); updateUI(); renderTimeline(); updateSituationButtonsState(); } renderPlayers(); closePositiveActionModal(); deactivatePassivePlay(); deactivateOpponent7v6(); }); });
            document.getElementById('closeSanctionsModalBtn').addEventListener('click', closeSanctionsModal);
            document.getElementById('sanctionYellow').addEventListener('click', () => { if (!currentPersonForAction) return; const {person, type} = currentPersonForAction; person.sanctions.yellow = 1; if(type === 'player') { const playerType = person.isGoalkeeper ? 'goalkeeper' : 'field_player'; const points = pointSystem[playerType].negative_actions['sanction_yellow'] || 0; updatePlayerScore(person, points); gameData.A.teamYellowCards++; person.negativeActions.push({ action: 'yellow_card', time: totalSeconds }); } else { gameData.A.officialsSanctions.yellow++; } logEvent('A', 'yellow_card', person.Nome, totalSeconds, `Cartão Amarelo: ${person.Nome}`); closeSanctionsModal(); renderPlayers(); renderOfficials(); deactivatePassivePlay(); deactivateOpponent7v6(); });
            document.getElementById('sanction2Min').addEventListener('click', () => { if (!currentPersonForAction) return; const {person, type} = currentPersonForAction; person.sanctions.twoMin++; if(type === 'player') { const playerType = person.isGoalkeeper ? 'goalkeeper' : 'field_player'; const points = pointSystem[playerType].negative_actions['sanction_2min'] || 0; updatePlayerScore(person, points); person.isSuspended = true; person.suspensionTimer = 120; person.onCourt = false; person.negativeActions.push({ action: '2min', time: totalSeconds }); if (person.sanctions.twoMin >= 3) { person.sanctions.red = 1; triggerTeamSuspension(); } } else { gameData.A.officialsSanctions.twoMin++; triggerTeamSuspension(); } logEvent('A', 'two_min', person.Nome, totalSeconds, `2 Minutos: ${person.Nome}`); checkAndLogSituationChange(); closeSanctionsModal(); renderPlayers(); renderOfficials(); renderTimeline(); deactivatePassivePlay(); deactivateOpponent7v6(); });
            document.getElementById('sanctionRed').addEventListener('click', () => { if (!currentPersonForAction) return; const {person, type} = currentPersonForAction; person.sanctions.red = 1; if(type === 'player') { const playerType = person.isGoalkeeper ? 'goalkeeper' : 'field_player'; const points = pointSystem[playerType].negative_actions['sanction_red'] || 0; updatePlayerScore(person, points); person.onCourt = false; person.negativeActions.push({ action: 'red_card', time: totalSeconds }); } else { gameData.A.officialsSanctions.red++; } logEvent('A', 'red_card', person.Nome, totalSeconds, `Cartão Vermelho: ${person.Nome}`); triggerTeamSuspension(); closeSanctionsModal(); renderPlayers(); renderOfficials(); deactivatePassivePlay(); deactivateOpponent7v6(); });
            document.getElementById('closeRemovePlayerModalBtn').addEventListener('click', closeRemovePlayerModal);
            
            // --- Other UI Listeners ---
            document.getElementById('teamBName').addEventListener('input', updateUI);
            timeoutBtnA.addEventListener('click', () => handleTimeout('A'));
            timeoutBtnB.addEventListener('click', () => handleTimeout('B'));
            
            // --- Tab Switching ---
            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(t => {
                        t.classList.remove('active', 'text-blue-400', 'border-blue-600');
                        t.classList.add('text-gray-400', 'border-transparent');
                    });
                    tab.classList.add('active', 'text-blue-400', 'border-blue-600');
                    tab.classList.remove('text-gray-400', 'border-transparent');
                    
                    const targetPanelId = tab.dataset.tab;
                    document.querySelectorAll('.tab-panel').forEach(panel => {
                        if (panel.id === targetPanelId) {
                            panel.classList.remove('hidden');
                        } else {
                            panel.classList.add('hidden');
                        }
                    });
                    if (targetPanelId === 'team-stats') {
                        renderTeamStats();
                        updateTeamCourtStats(document.getElementById('team-situation-select').value);
                    } else if (targetPanelId === 'individual-stats') {
                        renderIndividualStats();
                    } else if (targetPanelId === 'plus-minus') {
                        renderPlusMinusTab();
                    }
                });
            });

            // --- Stats Selects ---
            document.getElementById('player-stats-select').addEventListener('change', handleIndividualStatChange);
            document.getElementById('team-situation-select').addEventListener('change', (e) => {
                updateTeamCourtStats(e.target.value);
            });

            // --- Export Buttons ---
            exportExcelBtn.addEventListener('click', () => {
                const teamAName = document.getElementById('teamAName').value;
                const teamBName = document.getElementById('teamBName').value;

                // Team Stats Data
                const teamStatsData = [];
                const teamStatsContent = document.getElementById('team-stats-content');
                teamStatsContent.querySelectorAll('.grid').forEach(row => {
                    const cells = row.querySelectorAll('span');
                    if (cells.length === 5) {
                        teamStatsData.push({
                            'Estatística': cells[2].textContent,
                            [teamAName]: cells[0].textContent,
                            [teamBName]: cells[4].textContent
                        });
                    }
                });

                // Individual Stats Data
                const individualStatsData = gameData.A.players.map(p => {
                    const goals = p.shots.filter(s => s.outcome === 'goal').length;
                    const totalShots = p.shots.length;
                    const eff = totalShots > 0 ? ((goals / totalShots) * 100).toFixed(1) : '0.0';
                    const techFaults = p.negativeActions.filter(a => a.action === 'technical_fault').length;
                    const turnovers = p.negativeActions.filter(a => a.action === 'turnover').length;
                    return {
                        'Nº': p.Numero,
                        'Nome': p.Nome,
                        'Pontuação': p.performanceScore,
                        'Pontuação Final': p.finalScore,
                        'Golos': goals,
                        'Remates': totalShots,
                        'Efic. (%)': `${eff}%`,
                        'Tempo Jogo': formatTimeValue(p.timeOnCourt),
                        'Faltas Téc.': techFaults,
                        'Perdas Bola': turnovers,
                        'Am.': p.sanctions.yellow,
                        '2m': p.sanctions.twoMin,
                        'Vm.': p.sanctions.red
                    };
                });

                // Game Events Data
                const eventsData = gameEvents.map(e => ({
                    'Tempo': formatTimeValue(e.time),
                    'Equipa': e.team === 'A' ? teamAName : teamBName,
                    'Ação': e.type,
                    'Detalhes': e.details
                }));

                const wb = XLSX.utils.book_new();
                const wsTeam = XLSX.utils.json_to_sheet(teamStatsData);
                const wsIndividual = XLSX.utils.json_to_sheet(individualStatsData);
                const wsEvents = XLSX.utils.json_to_sheet(eventsData);

                XLSX.utils.book_append_sheet(wb, wsTeam, "Estatísticas da Equipa");
                XLSX.utils.book_append_sheet(wb, wsIndividual, "Estatísticas Individuais");
                XLSX.utils.book_append_sheet(wb, wsEvents, "Eventos do Jogo");

                XLSX.writeFile(wb, `Relatorio_Jogo_${teamAName}_vs_${teamBName}.xlsx`);
            });

            exportPdfBtn.addEventListener('click', () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const teamAName = document.getElementById('teamAName').value;
                const teamBName = document.getElementById('teamBName').value;
                
                doc.text(`Relatório do Jogo: ${teamAName} vs ${teamBName}`, 14, 15);
                doc.text(`Resultado Final: ${gameData.A.stats.goals} - ${gameData.B.stats.goals}`, 14, 22);

                // Team Stats
                const teamStatsBody = [];
                const teamStatsContent = document.getElementById('team-stats-content');
                teamStatsContent.querySelectorAll('.grid').forEach(row => {
                    const cells = row.querySelectorAll('span');
                    if (cells.length === 5) {
                        teamStatsBody.push([cells[2].textContent, cells[0].textContent, cells[4].textContent]);
                    }
                });

                doc.autoTable({
                    head: [['Estatística', teamAName, teamBName]],
                    body: teamStatsBody,
                    startY: 30,
                    headStyles: { fillColor: [41, 128, 185] },
                });

                // Individual Stats
                const individualStatsHead = [['Nº', 'Nome', 'Pts', 'Pts F.', 'Golos', 'Rem.', 'Efic.%', 'Tempo', 'FT', 'PB', 'Am', '2m', 'Vm']];
                const individualStatsBody = [];
                gameData.A.players.forEach(p => {
                    const goals = p.shots.filter(s => s.outcome === 'goal').length;
                    const totalShots = p.shots.length;
                    const eff = totalShots > 0 ? ((goals / totalShots) * 100).toFixed(1) : '0.0';
                    const techFaults = p.negativeActions.filter(a => a.action === 'technical_fault').length;
                    const turnovers = p.negativeActions.filter(a => a.action === 'turnover').length;
                    individualStatsBody.push([
                        p.Numero,
                        p.Nome,
                        p.performanceScore,
                        p.finalScore,
                        goals,
                        totalShots,
                        `${eff}%`,
                        formatTimeValue(p.timeOnCourt),
                        techFaults,
                        turnovers,
                        p.sanctions.yellow,
                        p.sanctions.twoMin,
                        p.sanctions.red
                    ]);
                });
                
                doc.autoTable({
                    head: individualStatsHead,
                    body: individualStatsBody,
                    startY: doc.autoTable.previous.finalY + 10,
                    headStyles: { fillColor: [41, 128, 185] },
                });

                // Game Events
                const eventsHead = [['Tempo', 'Equipa', 'Ação', 'Detalhes']];
                const eventsBody = gameEvents.map(e => [
                    formatTimeValue(e.time),
                    e.team === 'A' ? teamAName : teamBName,
                    e.type,
                    e.details
                ]);

                doc.autoTable({
                    head: eventsHead,
                    body: eventsBody,
                    startY: doc.autoTable.previous.finalY + 10,
                    headStyles: { fillColor: [41, 128, 185] },
                });

                doc.save(`Relatorio_Jogo_${teamAName}_vs_${teamBName}.pdf`);
            });

            // --- Game State Persistence ---
            const saveGameState = () => {
                try {
                    if (!gameData.A.fileLoaded) return;
                    const gameState = {
                        gameData,
                        totalSeconds,
                        currentGamePart,
                        isTimerRunning,
                        isPassivePlay,
                        isOpponent7v6,
                        gameEvents,
                        gameSituationLog,
                        lastKnownSituations,
                        teamAName: document.getElementById('teamAName').value,
                        teamBName: document.getElementById('teamBName').value
                    };
                    localStorage.setItem('handballGameState', JSON.stringify(gameState));
                } catch (error) {
                    console.error("Falha ao guardar o estado do jogo:", error);
                }
            };

            const loadGameState = () => {
                try {
                    const savedState = localStorage.getItem('handballGameState');
                    if (savedState) {
                        const gameState = JSON.parse(savedState);
                        gameData = gameState.gameData;
                        totalSeconds = gameState.totalSeconds;
                        currentGamePart = gameState.currentGamePart;
                        isTimerRunning = gameState.isTimerRunning;
                        isPassivePlay = gameState.isPassivePlay;
                        isOpponent7v6 = gameState.isOpponent7v6;
                        gameEvents = gameState.gameEvents;
                        gameSituationLog = gameState.gameSituationLog || [];
                        lastKnownSituations = gameState.lastKnownSituations || { A: 'equality', B: 'equality' };

                        document.getElementById('teamAName').value = gameState.teamAName;
                        document.getElementById('teamBName').value = gameState.teamBName;
                        timerDisplay.textContent = formatTimeValue(totalSeconds);
                        gamePartDisplay.textContent = `${currentGamePart}ª Parte`;

                        if (isPassivePlay) {
                            passivePlayBtn.classList.add('passive-active');
                            passivePlayBtn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        }
                        if (isOpponent7v6) {
                            opponent7v6Btn.classList.add('opponent-7v6-active');
                            opponent7v6Btn.classList.remove('bg-gray-700', 'hover:bg-gray-600');
                        }

                        welcomeModal.classList.add('hidden');
                        mainApp.classList.remove('hidden');

                        updateUI();
                        renderPlayers();
                        renderOfficials();
                        renderTimeline();
                        
                        if (isTimerRunning) {
                            isTimerRunning = false;
                            startTimer();
                        }
                        return true;
                    }
                } catch (error) {
                    console.error("Falha ao carregar o estado do jogo:", error);
                    localStorage.removeItem('handballGameState');
                }
                return false;
            };
            
            document.getElementById('resetGameBtn').addEventListener('click', () => {
                showConfirm('Tem a certeza que quer reiniciar o jogo? Todos os dados serão perdidos permanentemente.', () => {
                    localStorage.removeItem('handballGameState');
                    window.location.reload();
                });
            });

            if (!loadGameState()) {
                welcomeModal.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }

        });
    </script>
</body>
</html>
